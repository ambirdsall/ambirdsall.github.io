<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.8"/><meta name="theme-color" content="#663399"/><style data-href="/styles.1233a6cf8f631b5a2cd7.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}:root{--title-max-width:70%;--blur-radius:12px;--blur-radius--subtle:3px;--border-radius:1em}header{margin-bottom:1.45rem;padding:0 2rem;text-align:left}header.plaid{align-items:center;display:flex;justify-content:center}.plaid{background-color:#e9d4b9;background-image:repeating-linear-gradient(45deg,transparent 5px,rgba(11,36,45,.5) 0,rgba(11,36,45,.5) 10px,hsla(5,53%,63%,0) 0,hsla(5,53%,63%,0) 35px,hsla(5,53%,63%,.5) 0,hsla(5,53%,63%,.5) 40px,rgba(11,36,45,.5) 0,rgba(11,36,45,.5) 50px,rgba(11,36,45,0) 0,rgba(11,36,45,0) 60px,hsla(5,53%,63%,.5) 0,hsla(5,53%,63%,.5) 70px,rgba(247,179,85,.5) 0,rgba(247,179,85,.5) 80px,rgba(247,179,85,0) 0,rgba(247,179,85,0) 90px,hsla(5,53%,63%,.5) 0,hsla(5,53%,63%,.5) 110px,hsla(5,53%,63%,0) 0,hsla(5,53%,63%,0) 120px,rgba(11,36,45,.5) 0,rgba(11,36,45,.5) 140px),repeating-linear-gradient(135deg,transparent 5px,rgba(11,36,45,.5) 0,rgba(11,36,45,.5) 10px,hsla(5,53%,63%,0) 0,hsla(5,53%,63%,0) 35px,hsla(5,53%,63%,.5) 0,hsla(5,53%,63%,.5) 40px,rgba(11,36,45,.5) 0,rgba(11,36,45,.5) 50px,rgba(11,36,45,0) 0,rgba(11,36,45,0) 60px,hsla(5,53%,63%,.5) 0,hsla(5,53%,63%,.5) 70px,rgba(247,179,85,.5) 0,rgba(247,179,85,.5) 80px,rgba(247,179,85,0) 0,rgba(247,179,85,0) 90px,hsla(5,53%,63%,.5) 0,hsla(5,53%,63%,.5) 110px,hsla(5,53%,63%,0) 0,hsla(5,53%,63%,0) 140px,rgba(11,36,45,.5) 0,rgba(11,36,45,.5) 160px);color:hsla(0,0%,94%,.85)}header h1{font-size:3.14159em;font-weight:400;height:100%;letter-spacing:7px}.header-content{height:100%;margin:2rem 0;max-width:var(--title-max-width);padding:0 1.0875rem;width:100%}.plaid>.header-content{-webkit-backdrop-filter:blur(var(--blur-radius));backdrop-filter:blur(var(--blur-radius));border-radius:var(--border-radius);box-shadow:0 0 2em gray;padding:1.45rem 1.0875rem}footer{display:flex;justify-content:center}.footer-content{-webkit-backdrop-filter:blur(var(--blur-radius--subtle));backdrop-filter:blur(var(--blur-radius--subtle));border-radius:var(--border-radius);box-shadow:0 0 2em gray;height:-webkit-fit-content;height:-moz-fit-content;height:fit-content;margin:1.45rem 1.0875rem;max-width:var(--title-max-width);padding:1em;text-align:center}.icon-bar{display:flex;font-size:2em;justify-content:space-around;margin-bottom:.25rem}.icon-bar>a{color:hsla(0,0%,94%,.85)}.icon-bar>a:hover{color:#246}.shh{height:1px;left:-10000px;overflow:hidden;position:absolute;top:auto;width:1px}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Muli,sans-serif}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAAAAAA6mKC9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wgUFxgxChuixQAAAEpJREFUGNNtjzEOwFAIQrHjv/9VcaWD2lpSF83TCAQPdiVEraKgTShBi1AFhlADaiyMZ9lnoZYb9av7yS/Il/w+dVk35tYtXHj8G+Flt1tNaV/oAAAAAElFTkSuQmCC);margin:0}article,aside,details,figcaption,figure,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{word-wrap:break-word;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:georgia,serif;font-kerning:normal;font-weight:400}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{word-wrap:normal;background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{background:#e9e9d0;border-radius:3px;font-style:italic;margin:0 1.45rem 1.45rem;padding:11px}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}.container{margin:0 auto;max-width:70%;padding:0 1.0875rem 1.45rem;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content}@media only screen and (max-width:480px){.container{max-width:95%}}.token.operator{background:none}code[class*=language-],pre[class*=language-]{font-size:.8em}.post-link{font-size:.9em;margin:0 0 .5em 1em}.post-link:last-child{margin-bottom:1.3em}.post-link-date{color:#aaa;font-size:1.2em;margin-left:.62em;opacity:.6;vertical-align:sub}.triangle{align-items:center;display:flex;flex-direction:column;margin:3em 0 0}.triangle.big-bottom{margin-bottom:2em}.triangle .resizer{opacity:0;opacity:.2;transition:opacity .5s ease}.touch-device .resizer,.triangle:hover .resizer{opacity:1}input[type=range]{-webkit-appearance:none;margin:10px 0;width:100%}input[type=range]:focus{outline:none}input[type=range]::-webkit-slider-runnable-track{animate:.2s;background:hsla(42,28%,54%,.26);border:1px solid rgba(34,68,102,.1);border-radius:5px;box-shadow:0 0 0 #000;cursor:pointer;height:8px;width:100%}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;background:#fff;border:1px solid rgba(34,68,102,.5);border-radius:15px;box-shadow:0 0 0 #000031;cursor:pointer;height:20px;margin-top:-7px;width:20px}input[type=range]:focus::-webkit-slider-runnable-track{background:hsla(42,28%,54%,.26)}input[type=range]::-moz-range-track{animate:.2s;background:hsla(42,28%,54%,.26);border:1px solid rgba(34,68,102,.1);border-radius:5px;box-shadow:0 0 0 #000;cursor:pointer;height:8px;width:100%}input[type=range]::-moz-range-thumb{background:#fff;border:1px solid rgba(34,68,102,.5);border-radius:15px;box-shadow:0 0 0 #000031;cursor:pointer;height:20px;width:20px}input[type=range]::-ms-track{animate:.2s;background:transparent;border-color:transparent;color:transparent;cursor:pointer;height:8px;width:100%}input[type=range]::-ms-fill-lower,input[type=range]::-ms-fill-upper{background:hsla(42,28%,54%,.26);border:0 solid #010101;border-radius:2px;box-shadow:0 0 0 #000}input[type=range]::-ms-thumb{background:#fff;border:1px solid rgba(34,68,102,.5);border-radius:15px;box-shadow:0 0 0 #000031;cursor:pointer;height:20px;margin-top:1px;width:20px}input[type=range]:focus::-ms-fill-lower,input[type=range]:focus::-ms-fill-upper{background:hsla(42,28%,54%,.26)}body{color:#246;font-family:Muli,sans-serif}h2{color:#888;font-size:2em;font-weight:400;margin:.5em 0}.subtitle:before{color:#ddd;content:"〉"}@media only screen and (max-width:480px){h2{font-size:1.6em}.subtitle{text-align:center}}h3{font-size:1.2em;font-weight:400;margin-bottom:.3em}a{color:#024}.blog-post-container{font-family:Century Schoolbook,serif;margin:auto;padding:0 10%}.blog-post-date{color:#dd9}pre{padding:.5rem}@media only screen and (max-width:480px){header h1{font-size:2.5em}header h1,header h3{max-width:90%}.blog-post-content h2{font-size:1.3em}}</style><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="icon" href="/favicon-32x32.png?v=e06ff3ac86a0c187840479eaa6cda49e" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=e06ff3ac86a0c187840479eaa6cda49e"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=e06ff3ac86a0c187840479eaa6cda49e"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=e06ff3ac86a0c187840479eaa6cda49e"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=e06ff3ac86a0c187840479eaa6cda49e"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=e06ff3ac86a0c187840479eaa6cda49e"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=e06ff3ac86a0c187840479eaa6cda49e"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=e06ff3ac86a0c187840479eaa6cda49e"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=e06ff3ac86a0c187840479eaa6cda49e"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><header class="plaid"><div class="header-content"><h1>Locks Are Some Shit</h1><h3 class="blog-post-date">Thu Sep 01 2016</h3></div></header><div class="blog-post-container"><div class="blog-post"><div class="blog-post-content"><p>I&#x27;ve been reading <a href="http://pages.cs.wisc.edu/~remzi/OSTEP">Operating Systems: Three Easy
Pieces</a>. I highly recommend the book if
you&#x27;re cool fiddling with C a bit. Actually, scratch that: I recommend the book
if you ever write code that runs on a server or any other linux/osx environment,
<em>especially</em> if you feel a little out of your depth with C. The code examples
are not that intimidating, even if you don&#x27;t know from typecasting or a pointer
(okay, learning the difference between <code>foo</code>, <code>*foo</code> and <code>&amp;foo</code> is useful, but
not knowing it doesn&#x27;t prevent you from getting the gist of the code samples),
and getting a deeper understanding of the environment your code works in will
make a lot of known unknowns come into a bit more focus. Honest.</p>
<p>The first of the three parts was memory virtualization: that is, how computing
time and resources get divvied up amongst processes. There was some fascinating
stuff in there: the API for forking a new process, for instance, is weirder and
cooler than I expected, and learning the topography of the boundary between the
OS and application code (such as <code>ls</code> or <code>Google Chrome.app</code>) is rad. And then
there are parts that are totally internal, though vital, to the kernel. Nothing
against free space management, segmentation, or the five whole chapters on
memory paging, but I&#x27;m just not as interested in the kernel&#x27;s implementation as
its interface.</p>
<p>I kept wondering if I would be better off just jumping straight to concurrency,
because that&#x27;s what I was really pumped to learn. Would I be missing out on some
logically necessary information if I skipped them?? (Nope.) Learn from my
mistake and jump to the shit you find interesting, because someday you&#x27;re going
to die. So: <a href="http://pages.cs.wisc.edu/~remzi/OSTEP/threads-locks.pdf">locks</a>!</p>
<h2 id="i-dont-need-no-stinkin-lock" style="position:relative"><a href="#i-dont-need-no-stinkin-lock" aria-label="i dont need no stinkin lock permalink" class="anchor before"><div><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></div></a>I Don&#x27;t Need No Stinkin&#x27; Lock</h2>
<p>Locks are what keep multiple threads, running in parallel, from fucking each
other up when dealing with a shared bit of state. There is almost no operation
too small for these little bastards to mess up, given the chance. Take this:</p>
<pre><code class="language-c">static volatile int counter = 0;

void *mythread(void *arg) {
  int i;
  for (i = 0; i &lt; 100000; i++) {
    counter++;
  }
  return NULL;
}
</code></pre>
<p>Because I had to look it up: <code>volatile</code> is a keyword that prevents certain
compiler optimizations from happening, specifically for things like this shared
counter.</p>
<p>So, there&#x27;s a shared counter and there&#x27;s a procedure that uses it suitable for
giving to a couple threads. I extracted all the code dealing with that shared
bit of state:</p>
<pre><code class="language-c">counter++
</code></pre>
<p>That&#x27;s it! A single line, with a single unary operator. How unsafe can THAT be?
Let&#x27;s add some logging and fire up a couple threads:</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;pthread.h&gt;

static volatile int counter = 0;

void *mythread(void *arg) {
  printf(&quot;%s: begin\n&quot;, (char *) arg);
  int i;
  for (i = 0; i &lt; 100000; i++) {
    counter++;
  }
  printf(&quot;%s: end\n&quot;, (char *) arg);
  return NULL;
}

int main(int argc, char *argv[]) {
  pthread_t p1, p2;
  printf(&quot;main: begin (counter = %d)\n&quot;, counter);

  pthread_create(&amp;p1, NULL, mythread, &quot;A&quot;);
  pthread_create(&amp;p2, NULL, mythread, &quot;B&quot;);

  // wait for them fucks to finish
  pthread_join(p1, NULL);
  pthread_join(p2, NULL);

  printf(&quot;main: done with both (counter = %d)&quot;, counter);
  return 0;
}
</code></pre>
<p>So. <code>counter</code> starts at 0, and then two threads each run <code>counter++</code> 100,000
times apiece. That makes 200,000, right?</p>
<pre><code>main: begin (counter = 0)
A: begin
B: begin
B: end
A: end
main: done with both (counter = 100745)
</code></pre>
<p>INTERESTING.</p>
<p>The trouble is that <code>counter++</code> is <em>three</em> operations, not one:</p>
<ol>
<li>Get the value of <code>counter</code> out of whatever register it&#x27;s stored in</li>
<li>Increment that value by one</li>
<li>Store the new value in that register</li>
</ol>
<p>So <code>p2</code> reads the value of <code>counter</code>&#x27;s register at, e.g., 17; then it increments
the value to 18; at the same time as <code>p2</code> is doing that incrementing, one core
over, <code>p1</code> reads that same register, which is still 17. In parallel, each adds
one to the value it read and stores that new value in the register, and lo: 17 +
1 + 1 = 18.</p>
<h2 id="lock-that-shit-down" style="position:relative"><a href="#lock-that-shit-down" aria-label="lock that shit down permalink" class="anchor before"><div><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></div></a>Lock That Shit Down</h2>
<p>So let&#x27;s suppose you give a shit about the integrity of basic arithmetic in
your code. The above nonsense won&#x27;t do at all. I ran it eight times (you can,
too! Just stick the code above in a file (say, <code>bad_math.c</code>), compile it with
something like <code>gcc -o bad_math bad_math.c</code>, and go hog wild), with the following
results:</p>
<pre><code>ABAB 127499
ABAB 144926
ABAB 116942
ABBA 102988
ABBA 100745
ABAB 114188
AABB 200000
ABBA 104161

avg. 126431
</code></pre>
<p>I&#x27;m honestly pretty shocked that one run actually got 200,000. (As a sidenote,
it looks like the <code>ABAB</code> pattern of thread starts/finishes performs better than
<code>ABBA</code>, with respective averages of 125888 and 102631. <code>AABB</code>, of course, will
always get 200,000 (as would <code>BBAA</code>, but <code>A</code> gets kicked off first by
synchronous code).)</p>
<p>So let&#x27;s lock this shit down. <code>main</code> doesn&#x27;t need to change at all: we just need
to initialize a commonly available lock, and use it in the <code>mythread</code> procedure
to ensure that only one thread at a time can access the critical section (that&#x27;s
the term, coined by Dijkstra, for a section of code dealing with shared memory;
here, <code>counter++</code>). Here&#x27;s the most vanilla implementation for a POSIX system:</p>
<pre><code class="language-c">static volatile int counter = 0;
pthread_mutex_t lock = PTHREAD_MUTEX_INITIALIZER;

void *mythread(void *arg) {
  printf(&quot;%s: begin\n&quot;, (char *) arg);
  int i;
  for (i = 0; i &lt; 100000; i++) {
    pthread_mutex_lock(&amp;lock);
    counter += 1;
    pthread_mutex_unlock(&amp;lock);
  }
  printf(&quot;%s: end\n&quot;, (char *) arg);
  return NULL;
}
</code></pre>
<p>No need for extra headers; as you probably gathered from the naming, that
locking mechanism is part of <code>pthread.h</code>. When any thread calls
<code>pthread_mutex_lock(&amp;foo)</code> for a lock <code>foo</code>, one of two things happens: if no
one else has the lock, it runs the critical section; or, if another thread has
the lock, it waits for that thread to call <code>pthread_mutex_unlock(&amp;foo)</code> and THEN
does its thing.</p>
<p>As you might expect, this version gets 200,000 every time (but don&#x27;t believe
me...). So what&#x27;s going on under the hood?</p>
<h2 id="under-the-hood" style="position:relative"><a href="#under-the-hood" aria-label="under the hood permalink" class="anchor before"><div><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></div></a>Under The Hood</h2>
<p>A huge disclaimer before we start playing around with implementing our own
locks: this shit does not work. Checking some value to determine if a lock is in
use and updating that value to secure that lock takes multiple operations, and
at the application level, there&#x27;s no way to ensure that that happens atomically.
In a real lock, the hardware exposes a prebundled set of operations that can be
called from a C API.</p>
<p>Depending on your machine, those prebundled operations might look, if you
squint, a little something like this:</p>
<pre><code class="language-c">typedef struct __lock_t {
  int flag;
} lock_t;

void init(lock_t *lock) {
  // 0 =&gt; lock is available, 1 =&gt; lock is held
  lock-&gt;flag = 0;
}

int compare_and_swap(int *old_ptr, int expected, int new) {
  int actual = *old_ptr;
  if (actual == expected)
    *old_ptr = new;
  return actual;
}

void lock(lock_t *lock) {
  /* while (compare_and_swap(&amp;lock-&gt;flag, 0, 1) == 1) */
  while (compare_and_swap(&amp;lock-&gt;flag, 0, 1) == 1)
    ; // do butt-ass nothing until that lock gets released
}

void unlock(lock_t *lock) {
  lock-&gt;flag = 0;
}
</code></pre>
<p>This is a shitty lock for a few reasons:</p>
<ol>
<li>If the lock is taken, the thread just wastes CPU cycles until the CPU
scheduler decides to let the locking thread finish its work</li>
<li>It&#x27;s possible to have a thread that &quot;starves&quot;: i.e. never, ever gets the lock</li>
<li>It does not work.</li>
</ol>
<p>But <em>how badly</em> does it not work?</p>
<pre><code>ABAB 156000
ABAB 103114
ABAB 129168
ABBA 101519
ABBA 114152
ABAB 103095
ABBA 100576
ABAB 101809

avg. 113679
</code></pre>
<p>So, I mean, that&#x27;s a worse average than no lock at all, but there was that fluky
200,000 in there. Without the outlier, it would look a lot wors-</p>
<pre><code>avg. 115921
</code></pre>
<p>Oh. From an analytical perspective, there are more steps in <code>compare_and_swap</code>
than in <code>counter++</code>, so there are more places for a malicious CPU scheduler to
fuck with things; from a statistical perspective, we&#x27;re nowhere near solid
ground for declaring a winner in the contest of &quot;no locks vs useless locks&quot;;
from an engineering perspective, please just use <code>pthread_mutex_t</code> locks.</p>
<p>There is a glimmer of hope in the book before we totally close the book on
software locking:</p>
<p><img src="../../better_lock.png" alt="A lock written from x86 assembly instructions"/></p>
<p>Seems easy enough. Take the busted lock, swap in the new <code>CompareAndSwap</code>
implementation, however the fuck that works (looks like its evaluating literal
strings as assembly language, but I&#x27;m in way over my head here), and give that a
test run:</p>
<pre><code>ABAB 141034
ABAB 128868
ABAB 149149
ABAB 133336
ABAB 165496
ABAB 130632
ABAB 163608
ABAB 163309

avg. 146929
</code></pre>
<p>Not half bad*!</p>
<p>* Almost exactly half bad</p>
<p>That&#x27;s all I got rght now on locks.</p>
<h2 id="a-brief-aside-about-c" style="position:relative"><a href="#a-brief-aside-about-c" aria-label="a brief aside about c permalink" class="anchor before"><div><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></div></a>A Brief Aside About C</h2>
<p>Working in C feels like working with a database to me: the fundamental way to
define the shape of your data is a struct: a behaviorless mapping of typed data
fields to names, just like a table in a relational database.</p>
<p>Now, it&#x27;s more complicated than that, of course, and C is a good bit more
expressive than SQL. For instance, you could use the convention of pointing
certain fields at integers that are pointers to the memory address of functions
and use them to call those functions (I believe that&#x27;s how C++ classes work
under the hood, but don&#x27;t quote me on that as an authority).</p>
<h2 id="stuff-in-this-chapter-that-i-left-out" style="position:relative"><a href="#stuff-in-this-chapter-that-i-left-out" aria-label="stuff in this chapter that i left out permalink" class="anchor before"><div><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></div></a>Stuff In This Chapter That I Left Out</h2>
<ul>
<li>Various tradeoffs in balancing fairness and performance while maintaining
mutual exclusion (thus, incidentally, the term &quot;mutex&quot;)</li>
<li>Some interesting historical locking mechanisms</li>
<li>Some background on what the hardware does and doesn&#x27;t do, and what that means
for the OS</li>
<li>A cool-ass locking implementation from the linux kernel that tracks both the
status of the lock and the size of its queue with a single integer</li>
</ul></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blag/locks-are-some-shit";window.___webpackCompilationHash="66047af358de7229f2a1";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-d779ae985058eabbbc5d.js"]};/*]]>*/</script><script src="/app-d779ae985058eabbbc5d.js" async=""></script><script src="/1bfc9850-31a83d3e9b2d1d5a7a85.js" async=""></script><script src="/framework-94a7d1bc1fae8977e201.js" async=""></script><script src="/webpack-runtime-ad31a7b13803da6aeee4.js" async=""></script></body></html>