<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
    <link rel="stylesheet" href="../css/post.css">

    <title>ambirdsall - Zero-friction testing in rails</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blag/feed.xml" />
  </head>
  <body>
    <header>
      <div class="titles">
        <h1>Zero-friction testing in rails</h1>

        <h2 class="titles__icon-bar">
          <a href="http://github.com/ambirdsall"><span class="icon icon-github"></span></a>
          <a href="http://twitter.com/gobslapped"><span class="icon icon-twitter"></span></a>
          <a href="http://linkedin.com/in/ambirdsall"><span class="icon icon-linkedin"></span></a>
        </h2>
      </div>
    </header>

    <article>
      
<p>So. It wasn&rsquo;t until a few months ago that I finally worked on a software
project with full test coverage. Now that I have, I&rsquo;m a little shocked and
horrified it took this long: the quality of life is drastically better on
this side. The project in question is <a href="https://law.cornell.edu/rio">RIO</a>, an
ES6 legal citation parser I&rsquo;ve been building for Cornell Law&rsquo;s LII. I&rsquo;ve been
developing that solo, so I had the liberty of setting the testing mantle up to
suit my own workflow: heavily terminal-based, using vim and tmux.</p>

<p>I&rsquo;ve found that it&rsquo;s a massive help to be able to have tests constantly
rerunning in a splitscreen with vim every time I save a file. The constant
feedback means I don&rsquo;t need to keep switching mental context to see if my code
is correct: I can, while still in my editor, just glance over at a current test
run. This has utterly revolutionized how I feel about refactoring: knowing
exactly when my code breaks and unbreaks as I rearrange things is a massive
help for refactoring, and reveals bugs pretty much the instant they are
introduced. I haven&rsquo;t had to write a <code>debugger</code> in anger in a shockingly long
time. I want that confidence and speed when I work on rails projects, too.</p>

<p>So, to recap, I want</p>

<ol>
<li>fast tests that</li>
<li>run automatically on file save</li>
<li>run by a persistent server I can ogle in a tmux split while I vim away in
the same terminal window.</li>
</ol>

<p><h3 id="fast-tests">
  Fast tests
  <a class="section__title" href="#fast-tests">§</a>
</h2></p>

<p>The speed can be helped by <code>spring</code>, a gem that comes in rails&rsquo; default
<code>Gemfile</code> but which takes a bit of setup. Once you <em>have</em> set it up, though,
it&rsquo;s brilliant. After the first command which requires loading your rails app,
<code>spring</code> keeps running as a background process, with your application
environment loaded into memory. This means that the next time you run a command
that requires a loaded app, like your test suite, you get to skip the
several-second wait for rails to bootstrap itself­you only need to run
the test files themselves. Out of the box, <code>spring</code> only knows how to wrap the
<code>rails</code> and <code>rake</code> commands to use the preloaded app, but the
<code>spring-commands-rspec</code> gem expands that set to also wrap <code>rspec</code>, which I&rsquo;m
using for my tests.</p>

<p>Incidentally, I&rsquo;ve read things which assert that <code>minitest</code> is a good bit
faster than <code>rspec</code>; but <code>rspec</code> has quite a lot of community support, and I&rsquo;ve
been writing a ton of <code>jasmine</code> tests lately, which has wicked similar syntax.
The point of this is to lower the cognitive load of testing, after all. With a
massive test suite, though, the time savings might be worth switching over. As
always, measure: the old command-line standby <code>time</code> is your friend.</p>

<p><h3 id="running-automatically-on-file-save">
  Running automatically on file save
  <a class="section__title" href="#running-automatically-on-file-save">§</a>
</h2></p>

<p><code>guard</code> is the gem of choice here. It reads a <code>Guardfile</code> in the root of your
project: in that <code>Guardfile</code>, which is written in a ruby DSL, you define what
actions <code>guard</code> should run for given project files and which files to ignore.
If you, like I, are on osx, you should also install <code>rb-fsevent</code>, which makes
<code>guard</code> listen to osx&rsquo;s native FSEvents API instead of having to poll the disk
for changes (which is slower and takes more work from your CPU). You can
specify any command-line callback you like in your <code>Guardfile</code> with backticks,
but there are quite a few guard plugins that automatically set up conventional
rules for a conventional rails configuration and tool-specific configuration
options. Enter <code>guard-rspec</code>.</p>

<p>Here are the versions of all the gems I used when I went through this myself,
if you&rsquo;re into that sort of thing:</p>
<pre class="highlight plaintext"><code>guard 2.14.0
guard-rspec 4.7.3
rails 4.2.5
rb-fsevent 0.9.8
ruby 2.3.1
spring 2.0.0
spring-command-rspec 1.0.4
</code></pre>
<p><h3 id="lets-set-these-bad-not-specifically-gendered-children-up">
  Let&rsquo;s set these bad not-specifically-gendered children up
  <a class="section__title" href="#lets-set-these-bad-not-specifically-gendered-children-up">§</a>
</h2></p>

<p>In your <code>Gemfile</code>:</p>
<pre class="highlight ruby"><code><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'spring-commands-rspec'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span>
  <span class="n">gem</span> <span class="s1">'guard-rspec'</span>
  <span class="n">gem</span> <span class="s1">'rb-fsevent'</span> <span class="k">if</span> <span class="sb">`uname`</span> <span class="o">=~</span> <span class="sr">/Darwin/</span>
<span class="k">end</span>
</code></pre>
<p>And</p>
<pre class="highlight shell"><code>bundle
</code></pre>
<p><h3 id="setup-spring">
  Setup Spring
  <a class="section__title" href="#setup-spring">§</a>
</h2></p>

<p>To generate the command wrappers necessary to use the preloaded app, run</p>
<pre class="highlight shell"><code>spring binstub --all
</code></pre>
<p>which should generate some output along the lines of</p>
<pre class="highlight shell"><code><span class="k">*</span> bin/rake: spring inserted
<span class="k">*</span> bin/rspec: spring inserted
<span class="k">*</span> bin/rails: spring inserted
</code></pre>
<p>If you forgot to rebundle before running this or otherwise need to change the
configuration for <code>spring</code>, you&rsquo;ll need to stop and restart <code>spring</code> with</p>
<pre class="highlight shell"><code>spring stop
</code></pre>
<p>Otherwise, it will keep reusing the old outdated preloaded environment. And, if you&rsquo;re paranoid:</p>
<pre class="highlight shell"><code>spring status
</code></pre>
<p>For those quick tests I mentioned, just run</p>
<pre class="highlight shell"><code>bin/rspec
</code></pre>
<p><code>bin/rspec</code> is the wrapper script genreated back in the <code>spring binstub --all</code>
step. You could also run <code>rspec</code> through <code>spring</code> manually with</p>
<pre class="highlight shell"><code>spring rspec
</code></pre>
<p>Life is full of choices, and many of them don&rsquo;t matter. I timed both on some
empty spec files I scaffolded (with test output truncated, of course):</p>
<pre class="highlight shell"><code><span class="gp">% </span>spring stop
Spring stopped.

<span class="gp">% </span><span class="nb">time </span>bin/rspec

<span class="o">[</span>...]
Finished <span class="k">in </span>0.66145 seconds <span class="o">(</span>files took 0.61181 seconds to load<span class="o">)</span>
32 examples, 0 failures, 18 pending

bin/rspec  0.25s user 0.06s system 4% cpu 6.348 total

<span class="gp">% </span><span class="nb">time </span>bin/rspec

<span class="o">[</span>...]
Finished <span class="k">in </span>0.59806 seconds <span class="o">(</span>files took 0.58837 seconds to load<span class="o">)</span>
32 examples, 0 failures, 18 pending

bin/rspec  0.27s user 0.09s system 19% cpu 1.864 total

<span class="gp">% </span>spring stop
Spring stopped.

<span class="gp">% </span><span class="nb">time </span>spring rspec

<span class="o">[</span>...]
Finished <span class="k">in </span>0.58927 seconds <span class="o">(</span>files took 0.36102 seconds to load<span class="o">)</span>
32 examples, 0 failures, 18 pending

spring rspec  0.27s user 0.09s system 5% cpu 5.996 total

<span class="gp">% </span><span class="nb">time </span>spring rspec

<span class="o">[</span>...]
Finished <span class="k">in </span>0.57317 seconds <span class="o">(</span>files took 0.34346 seconds to load<span class="o">)</span>
32 examples, 0 failures, 18 pending

spring rspec  0.27s user 0.08s system 25% cpu 1.398 total
</code></pre>
<p>Either way, <code>spring</code> made the tests <em>much</em> faster after the first run, and
those savings persist so long as the spring server is running.</p>

<p><h3 id="setup-guard">
  Setup Guard
  <a class="section__title" href="#setup-guard">§</a>
</h2></p>

<p>I assume you already ran</p>
<pre class="highlight shell"><code>rails g rspec:install
</code></pre>
<p>but if you didn&rsquo;t yet, do. Then run</p>
<pre class="highlight shell"><code><span class="gp">% </span>guard init

01:34:28 - INFO - Writing new Guardfile to /Users/ambirdsall/code/rails/event_scheduler/Guardfile
01:34:28 - INFO - rspec guard added to Guardfile, feel free to edit it
</code></pre>
<p>Find this line of your new <code>Guardfile</code>:</p>
<pre class="highlight ruby"><code><span class="n">guard</span> <span class="ss">:rspec</span><span class="p">,</span> <span class="ss">cmd: </span><span class="s2">"bundle exec rspec"</span> <span class="k">do</span>
</code></pre>
<p>and change it to</p>
<pre class="highlight ruby"><code><span class="n">guard</span> <span class="ss">:rspec</span><span class="p">,</span> <span class="ss">cmd: </span><span class="s2">"bin/rspec"</span> <span class="k">do</span>
</code></pre>
<p>NICE.</p>

<p><h3 id="there-you-go">
  There you go
  <a class="section__title" href="#there-you-go">§</a>
</h2></p>

<p>Now just fire up <code>guard</code> with the command <code>guard</code>. Shazam! Your tests will run on save.</p>

<p>The little prompt <code>guard</code> gives you is an interactive ruby console, too, which
is really handy for double-checking the syntax of quick snippets when fixing
test failures. Use Ctrl-d to kill it, or just close your terminal.</p>
    </article>

    <footer>
      <div class="titles">
        <p>
          <a href="/">read other stuff</a><br>
          made with loaf by ambirdsall
        </p>
      </div>
    </footer>
  </body>
</html>
