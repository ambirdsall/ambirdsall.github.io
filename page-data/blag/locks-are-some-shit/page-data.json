{"componentChunkName":"component---src-templates-blog-template-js","path":"/blag/locks-are-some-shit","result":{"data":{"markdownRemark":{"html":"<p>I've been reading <a href=\"http://pages.cs.wisc.edu/~remzi/OSTEP\">Operating Systems: Three Easy\nPieces</a>. I highly recommend the book if\nyou're cool fiddling with C a bit. Actually, scratch that: I recommend the book\nif you ever write code that runs on a server or any other linux/osx environment,\n<em>especially</em> if you feel a little out of your depth with C. The code examples\nare not that intimidating, even if you don't know from typecasting or a pointer\n(okay, learning the difference between <code class=\"language-text\">foo</code>, <code class=\"language-text\">*foo</code> and <code class=\"language-text\">&amp;foo</code> is useful, but\nnot knowing it doesn't prevent you from getting the gist of the code samples),\nand getting a deeper understanding of the environment your code works in will\nmake a lot of known unknowns come into a bit more focus. Honest.</p>\n<p>The first of the three parts was memory virtualization: that is, how computing\ntime and resources get divvied up amongst processes. There was some fascinating\nstuff in there: the API for forking a new process, for instance, is weirder and\ncooler than I expected, and learning the topography of the boundary between the\nOS and application code (such as <code class=\"language-text\">ls</code> or <code class=\"language-text\">Google Chrome.app</code>) is rad. And then\nthere are parts that are totally internal, though vital, to the kernel. Nothing\nagainst free space management, segmentation, or the five whole chapters on\nmemory paging, but I'm just not as interested in the kernel's implementation as\nits interface.</p>\n<p>I kept wondering if I would be better off just jumping straight to concurrency,\nbecause that's what I was really pumped to learn. Would I be missing out on some\nlogically necessary information if I skipped them?? (Nope.) Learn from my\nmistake and jump to the shit you find interesting, because someday you're going\nto die. So: <a href=\"http://pages.cs.wisc.edu/~remzi/OSTEP/threads-locks.pdf\">locks</a>!</p>\n<h2 id=\"i-dont-need-no-stinkin-lock\" style=\"position:relative;\"><a href=\"#i-dont-need-no-stinkin-lock\" aria-label=\"i dont need no stinkin lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>I Don't Need No Stinkin' Lock</h2>\n<p>Locks are what keep multiple threads, running in parallel, from fucking each\nother up when dealing with a shared bit of state. There is almost no operation\ntoo small for these little bastards to mess up, given the chance. Take this:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">mythread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    counter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Because I had to look it up: <code class=\"language-text\">volatile</code> is a keyword that prevents certain\ncompiler optimizations from happening, specifically for things like this shared\ncounter.</p>\n<p>So, there's a shared counter and there's a procedure that uses it suitable for\ngiving to a couple threads. I extracted all the code dealing with that shared\nbit of state:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">counter<span class=\"token operator\">++</span></code></pre></div>\n<p>That's it! A single line, with a single unary operator. How unsafe can THAT be?\nLet's add some logging and fire up a couple threads:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">mythread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s: begin\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    counter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s: end\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">pthread_t</span> p1<span class=\"token punctuation\">,</span> p2<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main: begin (counter = %d)\\n\"</span><span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>p1<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> mythread<span class=\"token punctuation\">,</span> <span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>p2<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> mythread<span class=\"token punctuation\">,</span> <span class=\"token string\">\"B\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// wait for them fucks to finish</span>\n  <span class=\"token function\">pthread_join</span><span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">pthread_join</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main: done with both (counter = %d)\"</span><span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So. <code class=\"language-text\">counter</code> starts at 0, and then two threads each run <code class=\"language-text\">counter++</code> 100,000\ntimes apiece. That makes 200,000, right?</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">main: begin (counter = 0)\nA: begin\nB: begin\nB: end\nA: end\nmain: done with both (counter = 100745)</code></pre></div>\n<p>INTERESTING.</p>\n<p>The trouble is that <code class=\"language-text\">counter++</code> is <em>three</em> operations, not one:</p>\n<ol>\n<li>Get the value of <code class=\"language-text\">counter</code> out of whatever register it's stored in</li>\n<li>Increment that value by one</li>\n<li>Store the new value in that register</li>\n</ol>\n<p>So <code class=\"language-text\">p2</code> reads the value of <code class=\"language-text\">counter</code>'s register at, e.g., 17; then it increments\nthe value to 18; at the same time as <code class=\"language-text\">p2</code> is doing that incrementing, one core\nover, <code class=\"language-text\">p1</code> reads that same register, which is still 17. In parallel, each adds\none to the value it read and stores that new value in the register, and lo: 17 +\n1 + 1 = 18.</p>\n<h2 id=\"lock-that-shit-down\" style=\"position:relative;\"><a href=\"#lock-that-shit-down\" aria-label=\"lock that shit down permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lock That Shit Down</h2>\n<p>So let's suppose you give a shit about the integrity of basic arithmetic in\nyour code. The above nonsense won't do at all. I ran it eight times (you can,\ntoo! Just stick the code above in a file (say, <code class=\"language-text\">bad_math.c</code>), compile it with\nsomething like <code class=\"language-text\">gcc -o bad_math bad_math.c</code>, and go hog wild), with the following\nresults:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ABAB 127499\nABAB 144926\nABAB 116942\nABBA 102988\nABBA 100745\nABAB 114188\nAABB 200000\nABBA 104161\n\navg. 126431</code></pre></div>\n<p>I'm honestly pretty shocked that one run actually got 200,000. (As a sidenote,\nit looks like the <code class=\"language-text\">ABAB</code> pattern of thread starts/finishes performs better than\n<code class=\"language-text\">ABBA</code>, with respective averages of 125888 and 102631. <code class=\"language-text\">AABB</code>, of course, will\nalways get 200,000 (as would <code class=\"language-text\">BBAA</code>, but <code class=\"language-text\">A</code> gets kicked off first by\nsynchronous code).)</p>\n<p>So let's lock this shit down. <code class=\"language-text\">main</code> doesn't need to change at all: we just need\nto initialize a commonly available lock, and use it in the <code class=\"language-text\">mythread</code> procedure\nto ensure that only one thread at a time can access the critical section (that's\nthe term, coined by Dijkstra, for a section of code dealing with shared memory;\nhere, <code class=\"language-text\">counter++</code>). Here's the most vanilla implementation for a POSIX system:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">pthread_mutex_t</span> lock <span class=\"token operator\">=</span> PTHREAD_MUTEX_INITIALIZER<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">mythread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s: begin\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    counter <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s: end\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>No need for extra headers; as you probably gathered from the naming, that\nlocking mechanism is part of <code class=\"language-text\">pthread.h</code>. When any thread calls\n<code class=\"language-text\">pthread_mutex_lock(&amp;foo)</code> for a lock <code class=\"language-text\">foo</code>, one of two things happens: if no\none else has the lock, it runs the critical section; or, if another thread has\nthe lock, it waits for that thread to call <code class=\"language-text\">pthread_mutex_unlock(&amp;foo)</code> and THEN\ndoes its thing.</p>\n<p>As you might expect, this version gets 200,000 every time (but don't believe\nme...). So what's going on under the hood?</p>\n<h2 id=\"under-the-hood\" style=\"position:relative;\"><a href=\"#under-the-hood\" aria-label=\"under the hood permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Under The Hood</h2>\n<p>A huge disclaimer before we start playing around with implementing our own\nlocks: this shit does not work. Checking some value to determine if a lock is in\nuse and updating that value to secure that lock takes multiple operations, and\nat the application level, there's no way to ensure that that happens atomically.\nIn a real lock, the hardware exposes a prebundled set of operations that can be\ncalled from a C API.</p>\n<p>Depending on your machine, those prebundled operations might look, if you\nsquint, a little something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">__lock_t</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> flag<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token class-name\">lock_t</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">lock_t</span> <span class=\"token operator\">*</span>lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 0 => lock is available, 1 => lock is held</span>\n  lock<span class=\"token operator\">-></span>flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">compare_and_swap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>old_ptr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> expected<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> new<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> actual <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>old_ptr<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>actual <span class=\"token operator\">==</span> expected<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">*</span>old_ptr <span class=\"token operator\">=</span> new<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> actual<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">lock_t</span> <span class=\"token operator\">*</span>lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* while (compare_and_swap(&amp;lock->flag, 0, 1) == 1) */</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compare_and_swap</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>lock<span class=\"token operator\">-></span>flag<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">;</span> <span class=\"token comment\">// do butt-ass nothing until that lock gets released</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">lock_t</span> <span class=\"token operator\">*</span>lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  lock<span class=\"token operator\">-></span>flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is a shitty lock for a few reasons:</p>\n<ol>\n<li>If the lock is taken, the thread just wastes CPU cycles until the CPU\nscheduler decides to let the locking thread finish its work</li>\n<li>It's possible to have a thread that \"starves\": i.e. never, ever gets the lock</li>\n<li>It does not work.</li>\n</ol>\n<p>But <em>how badly</em> does it not work?</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ABAB 156000\nABAB 103114\nABAB 129168\nABBA 101519\nABBA 114152\nABAB 103095\nABBA 100576\nABAB 101809\n\navg. 113679</code></pre></div>\n<p>So, I mean, that's a worse average than no lock at all, but there was that fluky\n200,000 in there. Without the outlier, it would look a lot wors-</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">avg. 115921</code></pre></div>\n<p>Oh. From an analytical perspective, there are more steps in <code class=\"language-text\">compare_and_swap</code>\nthan in <code class=\"language-text\">counter++</code>, so there are more places for a malicious CPU scheduler to\nfuck with things; from a statistical perspective, we're nowhere near solid\nground for declaring a winner in the contest of \"no locks vs useless locks\";\nfrom an engineering perspective, please just use <code class=\"language-text\">pthread_mutex_t</code> locks.</p>\n<p>There is a glimmer of hope in the book before we totally close the book on\nsoftware locking:</p>\n<p><img src=\"../../better_lock.png\" alt=\"A lock written from x86 assembly instructions\"></p>\n<p>Seems easy enough. Take the busted lock, swap in the new <code class=\"language-text\">CompareAndSwap</code>\nimplementation, however the fuck that works (looks like its evaluating literal\nstrings as assembly language, but I'm in way over my head here), and give that a\ntest run:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ABAB 141034\nABAB 128868\nABAB 149149\nABAB 133336\nABAB 165496\nABAB 130632\nABAB 163608\nABAB 163309\n\navg. 146929</code></pre></div>\n<p>Not half bad*!</p>\n<p>* Almost exactly half bad</p>\n<p>That's all I got rght now on locks.</p>\n<h2 id=\"a-brief-aside-about-c\" style=\"position:relative;\"><a href=\"#a-brief-aside-about-c\" aria-label=\"a brief aside about c permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A Brief Aside About C</h2>\n<p>Working in C feels like working with a database to me: the fundamental way to\ndefine the shape of your data is a struct: a behaviorless mapping of typed data\nfields to names, just like a table in a relational database.</p>\n<p>Now, it's more complicated than that, of course, and C is a good bit more\nexpressive than SQL. For instance, you could use the convention of pointing\ncertain fields at integers that are pointers to the memory address of functions\nand use them to call those functions (I believe that's how C++ classes work\nunder the hood, but don't quote me on that as an authority).</p>\n<h2 id=\"stuff-in-this-chapter-that-i-left-out\" style=\"position:relative;\"><a href=\"#stuff-in-this-chapter-that-i-left-out\" aria-label=\"stuff in this chapter that i left out permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stuff In This Chapter That I Left Out</h2>\n<ul>\n<li>Various tradeoffs in balancing fairness and performance while maintaining\nmutual exclusion (thus, incidentally, the term \"mutex\")</li>\n<li>Some interesting historical locking mechanisms</li>\n<li>Some background on what the hardware does and doesn't do, and what that means\nfor the OS</li>\n<li>A cool-ass locking implementation from the linux kernel that tracks both the\nstatus of the lock and the size of its queue with a single integer</li>\n</ul>","frontmatter":{"date":"2016-09-01 07:20:17 UTC","path":"/blag/locks-are-some-shit","title":"Locks Are Some Shit"}}},"pageContext":{}},"staticQueryHashes":["3649515864","63159454"]}