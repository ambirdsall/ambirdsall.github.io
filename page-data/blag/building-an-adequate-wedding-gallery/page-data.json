{"componentChunkName":"component---src-templates-blog-template-js","path":"/blag/building-an-adequate-wedding-gallery","result":{"data":{"markdownRemark":{"html":"<h2 id=\"a-cool-ass-photo-album\" style=\"position:relative;\"><a href=\"#a-cool-ass-photo-album\" aria-label=\"a cool ass photo album permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A Cool-ass photo album</h2>\n<p>Our wedding photographer was a little slow in getting us our images, so I got\nto thinking about what to do. I decided I wanted a static image gallery, and I\nwanted it to be easy for anyone who came to get copies of photos they like,\nwhether for online use or making prints. For prints, people should be able to\ndownload the high-resolution originals, and those are such big files, it makes\nsense to zip the files before downloading. For digital use, there should be\nsmaller image files for download<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>,\nbut that could easily be handled entirely client-side.</p>\n<p>I decided that, in addition to normal \"download this photo\" usage, I wanted the\nability to</p>\n<ol>\n<li>Select any given subset of the images easily; and</li>\n<li>Download that set of images as a zip file</li>\n</ol>\n<p>This is a kinda fun UI problem AND has a fun backend problem despite dealing\nwith static data. Which is great: since we're not barring our photos from\nanyone, there's no need to implement any auth, which simplifies things.</p>\n<p>The zipping part means there needs to be some server code running; I decided to use\na rails app hosted on elastic beanstalk. I was already hosting the images on\ns3, and AWS designs all their services for easy interop (naturally, to keep all\nyour money going their way); besides, I had never hosted an app that way and I\nwanted to learn.</p>\n<p>Admittedly, for the initial version of this gallery, rails was overkill: just\nwithin the world of ruby development, Sinatra would be plenty for just an image\ngallery and a single zipping endpoint. But server-side overkill isn't\nnecessarily bad: as lost as it's fast and I don't mind paying for it (let's be\nreal, my family photos aren't going to get millions of distinct views any day\nsoon), there's no real downside<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup>. Besides:</p>\n<ol>\n<li>I have notions of extending the app with the ability to search and filter by\nname, and rails makes building out the additional models down the line quite\nstraightforward; and</li>\n<li>I wanted to practice working in and testing rails code for professional reasons</li>\n</ol>\n<p>So fuck it, rails it is.</p>\n<h2 id=\"open-zipper\" style=\"position:relative;\"><a href=\"#open-zipper\" aria-label=\"open zipper permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Open zipper?</h2>\n<p>I searched for \"zip\" on <a href=\"https://www.ruby-toolbox.com/search?q=zip\">Ruby\nToolbox</a>, and found two projects\nthat seemed to actually be intended for zipping files:</p>\n<p><img src=\"../../rubyzip-gem-stats.png\" alt=\"Rubyzip gem stats\"></p>\n<p><img src=\"../../zip-gem-stats.png\" alt=\"Zip gem stats\"></p>\n<p>I don't know how a popularity rating is calculated, but it has a Science Beaker\nicon, so it must be important. <a href=\"https://github.com/rubyzip/rubyzip\">Rubyzip</a>,\nit seems, is the gem for me.</p>\n<h2 id=\"zip-it-up\" style=\"position:relative;\"><a href=\"#zip-it-up\" aria-label=\"zip it up permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Zip it up.</h2>\n<p>That repo's <code class=\"language-text\">README.md</code> has some intro-type example code:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'rubygems'</span></span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'zip'</span></span>\n\nfolder <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"Users/me/Desktop/stuff_to_zip\"</span></span>\ninput_filenames <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'image.jpg'</span></span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">'description.txt'</span></span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">'stats.csv'</span></span><span class=\"token punctuation\">]</span>\n\nzipfile_name <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"/Users/me/Desktop/archive.zip\"</span></span>\n\nZip<span class=\"token double-colon punctuation\">::</span><span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>open<span class=\"token punctuation\">(</span>zipfile_name<span class=\"token punctuation\">,</span> Zip<span class=\"token double-colon punctuation\">::</span><span class=\"token builtin\">File</span><span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">CREATE</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>zipfile<span class=\"token operator\">|</span>\n  input_filenames<span class=\"token punctuation\">.</span><span class=\"token keyword\">each</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>filename<span class=\"token operator\">|</span>\n    <span class=\"token comment\"># Two arguments:</span>\n    <span class=\"token comment\"># - The name of the file as it will appear in the archive</span>\n    <span class=\"token comment\"># - The original file, including the path to find it</span>\n    zipfile<span class=\"token punctuation\">.</span>add<span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> folder <span class=\"token operator\">+</span> <span class=\"token string-literal\"><span class=\"token string\">'/'</span></span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n  zipfile<span class=\"token punctuation\">.</span>get_output_stream<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"myFile\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">|</span>os<span class=\"token operator\">|</span> os<span class=\"token punctuation\">.</span>write <span class=\"token string-literal\"><span class=\"token string\">\"myFile contains just this\"</span></span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>It's not clear from the example alone what files do and don't need to already\nexist to get this to work. I fiddled around until I got a minimal POC working,\nwhich looked something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># In the Gemfile, mind, you need</span>\n<span class=\"token comment\">#   gem 'rubyzip'</span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'zip'</span></span>\n\nfolder <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"/Users/ambirdsall/Desktop/actual_preexisting_directory\"</span></span>\ninput_filenames <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'actual_preexisting_file.png'</span></span><span class=\"token punctuation\">]</span>\n\nzipfile_name <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"/Users/ambirdsall/Desktop/not_yet_existing_archive_file.zip\"</span></span>\n\nZip<span class=\"token double-colon punctuation\">::</span><span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>open<span class=\"token punctuation\">(</span>zipfile_name<span class=\"token punctuation\">,</span> Zip<span class=\"token double-colon punctuation\">::</span><span class=\"token builtin\">File</span><span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">CREATE</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>zipfile<span class=\"token operator\">|</span>\n  input_filenames<span class=\"token punctuation\">.</span><span class=\"token keyword\">each</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>filename<span class=\"token operator\">|</span>\n    <span class=\"token comment\"># Two arguments:</span>\n    <span class=\"token comment\"># - The name of the file as it will appear in the archive</span>\n    <span class=\"token comment\"># - The original file, including the path to find it</span>\n    zipfile<span class=\"token punctuation\">.</span>add<span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> folder <span class=\"token operator\">+</span> <span class=\"token string-literal\"><span class=\"token string\">'/'</span></span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n  zipfile<span class=\"token punctuation\">.</span>get_output_stream<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"new_filename_for_streamed_data.txt\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>os<span class=\"token operator\">|</span>\n    os<span class=\"token punctuation\">.</span>write <span class=\"token string-literal\"><span class=\"token string\">\"I'm a dynamically-created plain text file\"</span></span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>To work inside a filesystem like this, <code class=\"language-text\">rubyzip</code> needs a full path to the\nsource files and the zipfile's directory (that all throws a big error if the\npath given to <code class=\"language-text\">zipfile.add</code> isn't valid); but the <code class=\"language-text\">zipfile_name</code> doesn't need to\nexist yet.</p>\n<p>More significantly, that <code class=\"language-text\">\"new_filename_for_streamed_data\"</code> business implies\nthat the filesystem can be skipped altogether for data which can be\nstreamed—from a database, say, <a href=\"https://github.com/ambirdsall/wedding_photos/blob/383ddcb249c657bfbf944533373d7d560cea11ab/app/actors/photo_fetcher.rb#L12-L16\">or s3</a>.</p>\n<p>This is plenty to work with: just get a list of selected images from the UI;\nuse that list to generate the corresponding s3 URLs; and then stream the\ncontents of each photo into a zipfile which is then sent to the user's browser\nfor download. The <code class=\"language-text\">zipfile.get_output_stream</code> trick can be used for a friendly\nindex.txt file down the line, after I've mapped each photo to the names of the\npeople in it.</p>\n<h2 id=\"coming-soon\" style=\"position:relative;\"><a href=\"#coming-soon\" aria-label=\"coming soon permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Coming Soon...</h2>\n<p>I'll dive into the design of the UI and of the server code soon, each in its own post.</p>\n\n      <div class=\"footnotes\">\n        <hr/>\n        <ol >\n    \n    <li class=\"footnote-list-item\" id=\"fn-1\" >\n          \n        <p class=\"footnote-paragraph\" style=\"display:inline; \">  I whipped up some <code>imagemagick</code> scripts to do batch resizing and\noptimizing, and hosted all the photos as public-read files in an s3 bucket.</p>\n      <a href=\"#fnref-1\" class=\"footnote-backref\" style=\"display:inline;text-decoration: none;\">\n        ↩\n      </a>\n    \n      </li>\n      \n    \n\n    <li class=\"footnote-list-item\" id=\"fn-2\" >\n          \n        <p class=\"footnote-paragraph\" style=\"display:inline; \">  Certainly nothing compared to sites that make you download megabytes of\njavascript before the first paint on mobile.</p>\n      <a href=\"#fnref-2\" class=\"footnote-backref\" style=\"display:inline;text-decoration: none;\">\n        ↩\n      </a>\n    \n      </li>\n      \n    </ol></div>","frontmatter":{"date":"2016-11-29 09:02:38 UTC","path":"/blag/building-an-adequate-wedding-gallery","title":"Building An Adequate Wedding Gallery"}}},"pageContext":{}},"staticQueryHashes":[]}