"use strict";(self.webpackChunkambirdsall_com=self.webpackChunkambirdsall_com||[]).push([[4443],{21:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>h});var o=n(64),a=n(4848),s=n(8453);const r={slug:"cut-out-the-middleman",title:"Rewriting a middleman site with gatsby",topic:"M E T A B L A G",date:new Date("2019-12-05T00:00:00.000Z")},i=void 0,d={authorsImageUrls:[]},h=[{value:"Problem: I had a new computer and my webpage had a fussy development env;",id:"problem-i-had-a-new-computer-and-my-webpage-had-a-fussy-development-env",level:2},{value:"and, having been exposed to JSX,",id:"and-having-been-exposed-to-jsx",level:2},{value:"and wanting to maintain a statically-generated site,",id:"and-wanting-to-maintain-a-statically-generated-site",level:2},{value:"the choice of gatsby seemed good, so I set to work.",id:"the-choice-of-gatsby-seemed-good-so-i-set-to-work",level:2},{value:"I had to figure out how to sort a list of posts;",id:"i-had-to-figure-out-how-to-sort-a-list-of-posts",level:2},{value:"then how to update the d3 triangle thing to modern d3 using es6 imports",id:"then-how-to-update-the-d3-triangle-thing-to-modern-d3-using-es6-imports",level:2},{value:"then how to embed a d3-controlled element in a react component",id:"then-how-to-embed-a-d3-controlled-element-in-a-react-component",level:2},{value:"and then I had a site!",id:"and-then-i-had-a-site",level:2}];function l(e){const t={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",section:"section",sup:"sup",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"It came to pass that after 3 years of neglect, I wanted to revive my old\nwebsite. I figured I'd add a post or two, maybe tweak a few things about the\nHTML and CSS, and then I could rewrite it in a different stack at my leisure.\nI think a lot of things that are wrong, though."}),"\n","\n",(0,a.jsx)(t.h2,{id:"problem-i-had-a-new-computer-and-my-webpage-had-a-fussy-development-env",children:"Problem: I had a new computer and my webpage had a fussy development env;"}),"\n",(0,a.jsxs)(t.p,{children:["I tried to run the development build, but ran into an error: I needed the right\nruby version. I've never done ruby development on this operating system, so I\ndon't have any tool in place to manage ruby versions. To fix things, I needed to\ninstall one of ",(0,a.jsx)(t.code,{children:"chruby"}),"/",(0,a.jsx)(t.code,{children:"rbenv"}),"/",(0,a.jsx)(t.code,{children:"rvm"}),"; setup ",(0,a.jsx)(t.code,{children:"nix"})," or ",(0,a.jsx)(t.code,{children:"guix"})," with ",(0,a.jsx)(t.code,{children:"direnv"}),"; or\nmaybe I could use ",(0,a.jsx)(t.code,{children:"asdf"})," or fuck if I know what the cool kids are doing these\ndays. Oy, what a hassle. Still, I eventually got on the version of ruby\nspecified in the Gemfile and I got a different error. Progress, right?"]}),"\n",(0,a.jsxs)(t.p,{children:["I needed to upgrade bundler, so I ran ",(0,a.jsx)(t.code,{children:"bundle update --bundler"}),". This, it seems,\novershot the mark: I needed to downgrade bundler, which is a bigger hassle than\nupgrading. Whatever: I uninstalled the new version and installed the specific\nolder one that was compatible with the rest of the project."]}),"\n",(0,a.jsxs)(t.p,{children:["With this, I could actually run the site locally! All was not well, though: it\nlooked like crap. It turned out that only some of the stylesheets I was loading\nfrom a ruby gem were available in practice, and the icon font I had been using\nwas nowhere to be found",(0,a.jsx)(t.sup,{children:(0,a.jsx)(t.a,{href:"#user-content-fn-1-3fbbcd",id:"user-content-fnref-1-3fbbcd","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})}),". At this point, I gave up: none of these problems were\ninsurmountable, but why go to all that effort when I wanted to rewrite it\nanyway?"]}),"\n",(0,a.jsx)(t.h2,{id:"and-having-been-exposed-to-jsx",children:"and, having been exposed to JSX,"}),"\n",(0,a.jsxs)(t.p,{children:["In the ruby version, I used ",(0,a.jsx)(t.code,{children:".erb"})," files to handle dynamic data and a few bits\nof html boilerplate. The way ",(0,a.jsx)(t.code,{children:".erb"})," files treat the non-logic contents as a dumb\ntext stream, not something with a tree structure, makes it fundamentally a worse\nfit for modeling HTML than the tree structure of JSX templates",(0,a.jsx)(t.sup,{children:(0,a.jsx)(t.a,{href:"#user-content-fn-3-3fbbcd",id:"user-content-fnref-3-3fbbcd","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})}),". Having\nworked with react and angular, I don't want to go back to the bad old days of\nwrangling HTML as raw text, I want to compose and encapsulate HTML using\ncomponents; and having used JSX, embedding the structural logic of the template\nwithin the content has begun to feel inside out. I didn't want to use another\ntemplating system."]}),"\n",(0,a.jsx)(t.h2,{id:"and-wanting-to-maintain-a-statically-generated-site",children:"and wanting to maintain a statically-generated site,"}),"\n",(0,a.jsxs)(t.p,{children:["(While ",(0,a.jsx)(t.code,{children:"create-react-app"})," is dope and all, there is zero dynamic content on this\nwhole site.)"]}),"\n",(0,a.jsx)(t.h2,{id:"the-choice-of-gatsby-seemed-good-so-i-set-to-work",children:"the choice of gatsby seemed good, so I set to work."}),"\n",(0,a.jsxs)(t.p,{children:["First I made the page shell; that was just porting some html to react\ncomponents. It happened that all I needed were well-documented, ",(0,a.jsx)(t.a,{href:"https://www.gatsbyjs.org/plugins/",children:"easily\nsearchable plugins"})," to ",(0,a.jsx)(t.a,{href:"https://www.gatsbyjs.org/packages/gatsby-transformer-remark/",children:"render\nmarkdown"}),"\ninto pages via a template; with ",(0,a.jsx)(t.a,{href:"https://www.gatsbyjs.org/packages/gatsby-remark-prismjs/",children:"colorized code\nblocks"}),";\nwith ",(0,a.jsx)(t.a,{href:"https://www.gatsbyjs.org/packages/gatsby-remark-autolink-headers/",children:"autolinked\nheaders"}),";\nwith\n",(0,a.jsx)(t.a,{href:"https://www.gatsbyjs.org/packages/gatsby-remark-footnotes/",children:"footnotes"}),"."]}),"\n",(0,a.jsx)(t.p,{children:"As a sidenote, pour one out for good sidenotes. I'm still holding out hope I\nfind a decent plugin I can use to finagle sidenotes from markdown without\nneeding to go all the way on some Tufte CSS theme. I don't think I'm likely to\ngo to the effort of coding one up myself anytime soon, though."}),"\n",(0,a.jsx)(t.p,{children:"Anyway, I had the existing posts rendering acceptably to HTML from pure\nmarkdown, getting autolinking and asides without needing any .erb equivalent."}),"\n",(0,a.jsx)(t.h2,{id:"i-had-to-figure-out-how-to-sort-a-list-of-posts",children:"I had to figure out how to sort a list of posts;"}),"\n",(0,a.jsxs)(t.p,{children:["This was straightforward: I wanted to group by topic, sort each topic by date,\nand sort the set of topics by date of most recent post. All the data I needed\nwas easily queryable from the markdown frontmatter via graphQL. You'll notice\nthat the remark plugin which renders the markdown exposes the list of rendered\nposts under a property named ",(0,a.jsx)(t.code,{children:"edges"})," and, to be honest, I'm not sure why: the\nname seems to describe the data's underlying topology rather than its API.\nWhatever."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-javascript",children:"// the page component's props are destructured like so:\n// ({\n//   data: {\n//     allMarkdownRemark: { edges },\n//     site: { siteMetadata: { title }},\n//   },\n// })\nconst postsByTopic = edges\n  .filter(e => !e.node.frontmatter.draft)\n  .map(e => e.node)\n  .reduce((topics, n) => {\n    const { topic } = n.frontmatter\n\n    // nobody likes to evaluate `undefined.push(n)`\n    topics[topic] = topics[topic] ? topics[topic] : []\n\n    topics[topic].push(n)\n    topics[topic].sort((a, b) => newestFirst(a, b))\n\n    return topics\n  }, {})\n\n// Order the topics by date of most recent post\nconst Posts = Object.values(postsByTopic)\n  .sort((a, b) => newestFirst(a[0], b[0]))\n  .map(renderSingleTopic)\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Before you ask, yes, I know that sorting topics each time a new post is added is\nan ",(0,a.jsx)(t.code,{children:"O(n\xb2)"})," algorithm, yes, I know that's improvable, and no, I don't care to\nmake it more efficient: posts are sorted once at build time, and I'd have to\npublish a post ever day for years (if not decades) before that ",(0,a.jsx)(t.code,{children:"n"})," gets big\nenough to be a problem. When efficiency is not important, always take the\napproach that's simplest to understand."]}),"\n",(0,a.jsxs)(t.p,{children:["I found it was significantly nicer to do the filtering in javascript than ruby.\nI was surprised by that, because I really love ruby's ",(0,a.jsx)(t.code,{children:"Enumerable"})," methods. But\njs objects are up with cons cells among my very favorite data structures to work\nwith, first-class functions make custom sorting comparators easy to add as\narguments, and ",(0,a.jsx)(t.code,{children:"Array.prototype"})," methods are just as chainable as\n",(0,a.jsx)(t.code,{children:"Enumerable"}),"s",(0,a.jsx)(t.sup,{children:(0,a.jsx)(t.a,{href:"#user-content-fn-4-3fbbcd",id:"user-content-fnref-4-3fbbcd","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"3"})}),". The definition of that ",(0,a.jsx)(t.code,{children:"newestFirst"})," comparator function is\nleft as an exercise to the reader, that's already a fair chunk of code."]}),"\n",(0,a.jsx)(t.h2,{id:"then-how-to-update-the-d3-triangle-thing-to-modern-d3-using-es6-imports",children:"then how to update the d3 triangle thing to modern d3 using es6 imports"}),"\n",(0,a.jsxs)(t.p,{children:["This wasn't too bad: I changed all the ",(0,a.jsx)(t.code,{children:"var"})," statements to ",(0,a.jsx)(t.code,{children:"const"}),"; fixed the\none variable I mutate in place (it's the easiest way to implement the algorithm)\nto use ",(0,a.jsx)(t.code,{children:"let"})," instead; and imported ",(0,a.jsx)(t.code,{children:"d3"}),". Modern versions of ",(0,a.jsx)(t.code,{children:"d3"})," export their\nconstituent parts as named exports, for ease of tree-shaking, so I had change\nthe code to import the functions I actually used instead of relying on the ",(0,a.jsx)(t.code,{children:"d3"}),"\nobject to have everything. ",(0,a.jsx)(t.code,{children:"d3.scale.linear()"})," had become ",(0,a.jsx)(t.code,{children:"d3.scaleLinear()"}),",\nbut otherwise this was a pretty mechanical translation."]}),"\n",(0,a.jsx)(t.h2,{id:"then-how-to-embed-a-d3-controlled-element-in-a-react-component",children:"then how to embed a d3-controlled element in a react component"}),"\n",(0,a.jsxs)(t.p,{children:["Figuring this part out was kind of fun! The basic 2-step to mounting a\nself-contained ",(0,a.jsx)(t.code,{children:"d3"})," visualization inside of a react app:"]}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.code,{children:"const domElementRef = useRef(null)"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.code,{children:"useEffect(() => d3.select(domElementRef.current).doStuffWith(props.data), [props.data])"})}),"\n"]}),"\n",(0,a.jsxs)(t.p,{children:["That's the general approach, since usually a ",(0,a.jsx)(t.code,{children:"d3"})," visualization is based on some\ninput data and should rerender when and if the data changes; mine uses\nrandomly-generated data, though, so I didn't even need the dependency array."]}),"\n",(0,a.jsxs)(t.p,{children:["Regardless, it's much nicer to do with hooks than lifecycle methods, where you'd\nneed to use both ",(0,a.jsx)(t.code,{children:"componentDidMount"})," and ",(0,a.jsx)(t.code,{children:"componentDidUpdate"})," to ensure the\nvisualization ran at all the appropriate times."]}),"\n",(0,a.jsx)(t.h2,{id:"and-then-i-had-a-site",children:"and then I had a site!"}),"\n",(0,a.jsx)(t.p,{children:"I hope you like it."}),"\n",(0,a.jsxs)(t.p,{children:["It is very popular to try to dunk on the javascript ecosystem in various parts\nof programmer culture",(0,a.jsx)(t.sup,{children:(0,a.jsx)(t.a,{href:"#user-content-fn-2-3fbbcd",id:"user-content-fnref-2-3fbbcd","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"4"})}),", and one of the very most popular ways is to clown on\nthe size of the ",(0,a.jsx)(t.code,{children:"node_modules"})," directory. Since ",(0,a.jsx)(t.code,{children:"npm"})," installs every package on\na per-project basis; since it errs on the side of having multiple (potentially\nincompatible) versions of transitive dependencies rather than forcing you to\njust choose one; and since javascript itself has a very small standard library,\nleading to heavy use of library code; it's common to have large ",(0,a.jsx)(t.code,{children:"node_modules"}),"\ndirectories on your hard drive. Clown all you want, but the self-containment of\nthat approach would have saved me a bunch of hassle here. Or maybe I just had a\nbadly-written ",(0,a.jsx)(t.code,{children:"Gemfile"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["I have the strong impression that this is at least in\npart sub-rosa sexism: frontend work, being user-facing and visual, fits\nstereotypes of women's work, and indeed many female programmers are channeled\ninto frontend work regardless of their specific interests or abilities.\nNeckbeards huddle together discussing the manly arts of functional programming,\nasynchronous logic, optimizing dependency graphs, and distributed computing,\nnever pausing to consider that those are all part and\n",(0,a.jsx)(t.a,{href:"https://parceljs.org/",children:"parcel"})," of frontend work. But I digress."]}),"\n",(0,a.jsx)(t.p,{children:"I have an intuition that this has to do with the ol' Chomsky hierarchy,\nakin to how regular expression can scan text streams in sophisticated ways but\ncan't validate structural features like valid nesting or pairing."}),"\n",(0,a.jsxs)(t.p,{children:["A rant: what the fuck is up with how ",(0,a.jsx)(t.code,{children:"sort"})," mutates the array in place?\nIt's totally out of character with the rest of the ",(0,a.jsx)(t.code,{children:"Array.prototype"})," chainable\nmethods, which return new arrays, and its idiosyncracy offers no benefit: it's\njust a footgun which makes it easy to mutate your application data behind your\nown back. I realize backwards compatibility means we're stuck with a mutating\n",(0,a.jsx)(t.code,{children:"sort"}),", but I really do think the next iteration of the language should add a\nnew ",(0,a.jsx)(t.code,{children:"Array.prototype.sorted"})," method which returns a new sorted array."]}),"\n","\n",(0,a.jsxs)(t.section,{"data-footnotes":!0,className:"footnotes",children:[(0,a.jsx)(t.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsxs)(t.li,{id:"user-content-fn-1-3fbbcd",children:["\n",(0,a.jsx)(t.a,{href:"#user-content-fnref-1-3fbbcd","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{id:"user-content-fn-3-3fbbcd",children:["\n",(0,a.jsx)(t.a,{href:"#user-content-fnref-3-3fbbcd","data-footnote-backref":"","aria-label":"Back to reference 2",className:"data-footnote-backref",children:"\u21a9"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{id:"user-content-fn-4-3fbbcd",children:["\n",(0,a.jsx)(t.a,{href:"#user-content-fnref-4-3fbbcd","data-footnote-backref":"","aria-label":"Back to reference 3",className:"data-footnote-backref",children:"\u21a9"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{id:"user-content-fn-2-3fbbcd",children:["\n",(0,a.jsx)(t.a,{href:"#user-content-fnref-2-3fbbcd","data-footnote-backref":"","aria-label":"Back to reference 4",className:"data-footnote-backref",children:"\u21a9"}),"\n"]}),"\n"]}),"\n"]})]})}function c(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},64:e=>{e.exports=JSON.parse('{"permalink":"/blog/cut-out-the-middleman","source":"@site/blog/blog-rewrite.mdx","title":"Rewriting a middleman site with gatsby","description":"It came to pass that after 3 years of neglect, I wanted to revive my old","date":"2019-12-05T00:00:00.000Z","tags":[],"readingTime":7.435,"hasTruncateMarker":true,"authors":[],"frontMatter":{"slug":"cut-out-the-middleman","title":"Rewriting a middleman site with gatsby","topic":"M E T A B L A G","date":"2019-12-05T00:00:00.000Z"},"unlisted":false,"lastUpdatedAt":1745535817000,"prevItem":{"title":"On that fractal triforce thing there","permalink":"/blog/on-the-sierpinski-triangle-thing"},"nextItem":{"title":"Why emacs is worth the bother","permalink":"/blog/why-emacs-is-worth-the-bother"}}')},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>i});var o=n(6540);const a={},s=o.createContext(a);function r(e){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),o.createElement(s.Provider,{value:t},e.children)}}}]);