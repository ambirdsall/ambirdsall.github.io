"use strict";(self.webpackChunkambirdsall_com=self.webpackChunkambirdsall_com||[]).push([[67],{8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(6540);const o={},s=r.createContext(o);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:n},e.children)}},8866:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>h,default:()=>m,frontMatter:()=>d,metadata:()=>r,toc:()=>p});const r=JSON.parse('{"id":"noisebot/index","title":"I, Noisebot","description":"Or: How I made playing records through my home Sonos set up nice with some DIY dedicated hardware. You can find the project code on my github.","source":"@site/projects/noisebot/index.mdx","sourceDirName":"noisebot","slug":"/noisebot/","permalink":"/projects/noisebot/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"projectSidebar","previous":{"title":"Projects of mine","permalink":"/projects/"},"next":{"title":"Setting Up The Mini Keyboard","permalink":"/projects/noisebot/mini-keyboard"}}');var o=t(4848),s=t(8453),i=t(8774),a=t(2331);const l=t.p+"assets/images/mini-keeb-1df4f174d208680a47718782f84b2c60.avif",d={},h="I, Noisebot",c={},p=[{value:"The Problem",id:"the-problem",level:2},{value:"A Better Way",id:"a-better-way",level:2},{value:"The breakthrough: finding a library to control the speakers",id:"the-breakthrough-finding-a-library-to-control-the-speakers",level:2}];function x(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",section:"section",sup:"sup",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"i-noisebot",children:"I, Noisebot"})}),"\n",(0,o.jsxs)(n.p,{children:["Or: How I made playing records through my home Sonos set up nice with some DIY dedicated hardware. You can find the project code ",(0,o.jsx)(n.a,{href:"https://github.com/ambirdsall/noisebot",children:"on my github"}),"."]}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsx)(n.p,{children:"This write-up was started a few months after finishing the project, and so there is a chance I have misremembered some detail, some side learning, some bit of context. Do leave a comment if you catch a mistake!"})}),"\n",(0,o.jsx)(n.h2,{id:"the-problem",children:"The Problem"}),"\n",(0,o.jsxs)(n.p,{children:["I bought a couple of Sonos speakers some years back. It has been great for streaming digital audio, but some of the shine wore off when I added my phonograph to the system",(0,o.jsx)(n.sup,{children:(0,o.jsx)(n.a,{href:"#user-content-fn-1",id:"user-content-fnref-1","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})}),". I was using a setup something like this:"]}),"\n",(0,o.jsx)(n.mermaid,{value:'graph TB\n    A["Bedroom<br>\ud83d\udd0a"]\n    B["Kitchen<br>\ud83d\udd0a"]\n    C["Living Room<br>\ud83d\udd0a"]\n    D["TV Room<br>\ud83d\udd0a"]\n    \n    %% Vertical alignment for analog components\n    subgraph AnalogSource[" "]\n        direction TB\n        Phono["Record Player<br>\ud83c\udfb5 "]\n        E["Line In<br>\ud83c\udfb5\ud83d\udd17\ud83d\udd08"]\n        Phono --\x3e E\n    end\n\n    class A,B,C,D speakerNode;\n\n    %% Dotted grey bidirectional connections\n    B <-.-> C\n    B <-.-> D\n    E <-.-> B\n    E <-.-> C\n    E <-.-> D\n    A <-.-> B\n    A <-.-> C\n    A <-.-> D\n    E <-.-> A\n\n    classDef speakerNode fill:#d1e8ff,stroke:#1e90ff,stroke-width:2px,color:#000;\n    linkStyle default stroke:#999,stroke-dasharray: 4 4;\n    linkStyle 0 stroke:#333,stroke-width:2px,stroke-dasharray: 0;'}),"\n",(0,o.jsx)(n.p,{children:"I didn't have speakers wired to the Line In box, which meant actually playing a record required the following steps:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"take out my smartphone and open the sonos app"}),"\n",(0,o.jsx)(n.li,{children:'go to the "rooms" tab'}),"\n",(0,o.jsx)(n.li,{children:'select the "Line In" device'}),"\n",(0,o.jsx)(n.li,{children:'hit the "Group" button and connect another speaker\u2014"Living Room", say'}),"\n",(0,o.jsx)(n.li,{children:'go to the "browse" tab'}),"\n",(0,o.jsx)(n.li,{children:'select the "Line in" input (provided by the Line In "room", i.e. device)'}),"\n",(0,o.jsx)(n.li,{children:"put the record on the phonograph"}),"\n",(0,o.jsx)(n.li,{children:"start the phonograph spinning"}),"\n",(0,o.jsx)(n.li,{children:"put the needle down"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Changing the volume was another whole round of taps:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"take out phone, open sonos app"}),"\n",(0,o.jsx)(n.li,{children:'back to the "rooms" tab'}),"\n",(0,o.jsx)(n.li,{children:"select the line in group"}),"\n",(0,o.jsx)(n.li,{children:"pull up selected group's playback controls to get volume"}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["It was all perfectly ",(0,o.jsx)(n.em,{children:"doable"}),"\u2014and credit where due, the volume slider interface is very nice when you get there\u2014but tapping through all those screens added friction, made it feel like a chore, and we didn't listen to records at all for a long time. There had to be a better way."]}),"\n",(0,o.jsx)(n.h2,{id:"a-better-way",children:"A Better Way"}),"\n",(0,o.jsx)(n.p,{children:"Here's the process I wanted:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"put the record on the phonograph"}),"\n",(0,o.jsx)(n.li,{children:"start the phonograph spinning"}),"\n",(0,o.jsx)(n.li,{children:"press some easy to reach button next to the phonograph that does all the work to connect speaker(s) and route audio"}),"\n",(0,o.jsx)(n.li,{children:"put the needle down"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"And for changing the volume:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"twiddle a volume knob"}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["I had a UI in mind, even: as a programmer, I do enough typing to have researched keyboard enthusiast spaces online, and there I had seen several examples of macro pads",(0,o.jsx)(n.sup,{children:(0,o.jsx)(n.a,{href:"#user-content-fn-4",id:"user-content-fnref-4","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})})," equipped with a handful of remappable keys and a rotary knob. Here's the layout I ended up going with, but I could have gone smaller: the whole top row was optional."]}),"\n",(0,o.jsxs)("svg",{viewBox:"0 0 260 120",width:"100%",height:"auto",xmlns:"http://www.w3.org/2000/svg",style:{maxWidth:"300px",margin:"2rem auto",display:"block"},children:[(0,o.jsx)("rect",{x:"10",y:"10",width:"50",height:"40",rx:"8",fill:"#eee",stroke:"#333"}),(0,o.jsx)("text",{x:"35",y:"35",fontSize:"16",textAnchor:"middle",fill:"#333",children:"b"}),(0,o.jsx)("rect",{x:"70",y:"10",width:"50",height:"40",rx:"8",fill:"#eee",stroke:"#333"}),(0,o.jsx)("text",{x:"95",y:"35",fontSize:"16",textAnchor:"middle",fill:"#333",children:"p"}),(0,o.jsx)("rect",{x:"130",y:"10",width:"50",height:"40",rx:"8",fill:"#eee",stroke:"#333"}),(0,o.jsx)("text",{x:"155",y:"35",fontSize:"16",textAnchor:"middle",fill:"#333",children:"f"}),(0,o.jsx)("rect",{x:"10",y:"70",width:"50",height:"40",rx:"8",fill:"#eee",stroke:"#333"}),(0,o.jsx)("text",{x:"35",y:"95",fontSize:"16",textAnchor:"middle",fill:"#333",children:"l"}),(0,o.jsx)("rect",{x:"70",y:"70",width:"50",height:"40",rx:"8",fill:"#eee",stroke:"#333"}),(0,o.jsx)("text",{x:"95",y:"95",fontSize:"16",textAnchor:"middle",fill:"#333",children:"t"}),(0,o.jsx)("rect",{x:"130",y:"70",width:"50",height:"40",rx:"8",fill:"#eee",stroke:"#333"}),(0,o.jsx)("text",{x:"155",y:"95",fontSize:"16",textAnchor:"middle",fill:"#333",children:"k"}),(0,o.jsx)("circle",{cx:"220",cy:"60",r:"35",fill:"#ccc",stroke:"#333",strokeWidth:"2"}),(0,o.jsx)("text",{x:"220",y:"48",fontSize:"14",textAnchor:"middle",fill:"#000",children:"\u21bb u"}),(0,o.jsx)("text",{x:"220",y:"65",fontSize:"14",textAnchor:"middle",fill:"#000",children:"\u21ba d"}),(0,o.jsx)("text",{x:"220",y:"81",fontSize:"12",textAnchor:"middle",fill:"#222",children:"(m)"})]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["top row: playback controls","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["left: ",(0,o.jsx)(n.code,{children:"b"}),"ackwards track"]}),"\n",(0,o.jsxs)(n.li,{children:["middle: ensure ",(0,o.jsx)(n.code,{children:"p"}),"honograph is audio source"]}),"\n",(0,o.jsxs)(n.li,{children:["right: ",(0,o.jsx)(n.code,{children:"f"}),"orwards track"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["bottom: device toggles","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"l"}),"iving room speaker"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"t"}),"v soundbar"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"k"}),"itchen speaker"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["knob:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["clockwise: ",(0,o.jsx)(n.code,{children:"u"}),"p volume"]}),"\n",(0,o.jsxs)(n.li,{children:["counterclockwise: ",(0,o.jsx)(n.code,{children:"d"}),"own volume"]}),"\n",(0,o.jsxs)(n.li,{children:["press: toggle ",(0,o.jsx)(n.code,{children:"m"}),"ute"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"the-breakthrough-finding-a-library-to-control-the-speakers",children:"The breakthrough: finding a library to control the speakers"}),"\n",(0,o.jsxs)(n.p,{children:["I knew Sonos speakers coordinate with network requests over wifi",(0,o.jsx)(n.sup,{children:(0,o.jsx)(n.a,{href:"#user-content-fn-2",id:"user-content-fnref-2","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"3"})}),'; if I had a programatic way to send the same kind of network requests, I could use trigger it with that macro pad and automate away all the bother with telephones. If you press the "living room" button, the speaker there either starts or stops playing the record; turn the volume knob, the volume changes. Creating a wrapper library was likely a matter of observing and reverse-engineering some private HTTP api, and people do that every day. To a search engine!']}),"\n",(0,o.jsxs)(n.p,{children:["There were indeed some open-source libraries for interacting with sonos, and they were all on npm; I've written a lot of javascript in my career, so a node script was old hat. ",(0,o.jsx)(n.em,{children:"Marvelous."})," I did some quick experiments; the one that made it easiest to find my speakers and order them around goes by ",(0,o.jsx)(n.code,{children:"sonos"})," on npm and ",(0,o.jsx)(n.code,{children:"node-sonos"})," ",(0,o.jsx)(n.a,{href:"https://github.com/bencevans/node-sonos",children:"on github"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["For hardware, I had an unused Raspberry Pi Zero",(0,o.jsx)(n.sup,{children:(0,o.jsx)(n.a,{href:"#user-content-fn-3",id:"user-content-fnref-3","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"4"})})," around: that gave me a computer which was tiny enough to stash in a small device, while still having a wifi antenna to communicate with the speakers and enough CPU to run a node script in an ordinary linux terminal. The programming model looked straightforward, too: the macropad was just a funny USB keyboard, so I could directly connect it to the pi while running the script, which just has to listen for characters coming in on ",(0,o.jsx)(n.code,{children:"stdin"})," and get ready to trigger callbacks when it reads the right ones. My plan was coming together nicely:"]}),"\n",(0,o.jsx)(n.mermaid,{value:'graph TD\n    subgraph "Hey let\'s hear a record"\n        Keyboard["Macro Pad<br>(\u2328 + \ud83c\udf9b)"]\n        Pi["Raspberry Pi Zero W<br>\ud83e\udd16 running a <code>node-sonos</code>-based node.js script"]\n        Keyboard --\x3e Pi\n    end\n\n    subgraph "Sonos System"\n        Speakers["Living Room et al<br>\ud83d\udd0a\ud83d\udd0a\ud83d\udd0a"]\n        ConnectAmp["Line In<br>\ud83c\udfb5\ud83d\udd17\ud83d\udd08"]\n        Phono["Record Player<br>\ud83c\udfb5 "]\n\n        Phono --\x3e ConnectAmp\n        Speakers <-.-> ConnectAmp\n    end\n\n    Pi -.-> Speakers\n    Pi -.-> ConnectAmp\n\n    %% Style only the dotted arrows (links 5 and 6)\n    linkStyle 2 stroke:#888,stroke-dasharray: 5;\n    linkStyle 3 stroke:#888,stroke-dasharray: 5;\n    linkStyle 4 stroke:#888,stroke-dasharray: 5;'}),"\n",(0,o.jsxs)(n.p,{children:["This looked close to ideal, and the only thing I didn't already own was a little macro pad; so I went ahead and ordered ",(0,o.jsx)(n.a,{href:"https://www.aliexpress.us/item/3256807827316893.html",children:"the cheapest one I could find on aliexpress"}),":"]}),"\n",(0,o.jsx)("div",{style:{margin:"auto",width:"20em"},children:(0,o.jsx)(a.A,{img:l})}),"\n",(0,o.jsx)(n.p,{children:"With my hardware assembled, I still had to complete three tasks, which could all be\u2014at least partially\u2014developed in isolation:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(i.A,{to:"./scripting",children:(0,o.jsx)("strong",{children:"write a headless but interactive sonos TUI as a node.js script:"})})," I could write and run the code on a normal laptop if the Raspberry Pi weren't ready, using the laptop keyboard to trigger actions if the mini one weren't ready"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(i.A,{to:"./mini-keyboard",children:(0,o.jsx)("strong",{children:"set up a raspberry pi zero to run that script"})}),", using a laptop keyboard over ",(0,o.jsx)(n.code,{children:"ssh"})," to test the script if the mini keyboard weren't ready"]}),"\n",(0,o.jsxs)(n.li,{children:["find out ",(0,o.jsx)(i.A,{to:"./raspberry-pi-zero",children:(0,o.jsx)("strong",{children:"what codes my mini keyboard sends"})})," for each key and the knob, remapping them as needed; this has no dependency on the Raspberry Pi at all."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Each problem has a dedicated page with a more detailed explanation. Let's dig in!"}),"\n","\n",(0,o.jsxs)(n.section,{"data-footnotes":!0,className:"footnotes",children:[(0,o.jsx)(n.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{id:"user-content-fn-1",children:["\n",(0,o.jsxs)(n.p,{children:["Part of this was just collateral damage from a classically graceless corporate upgrade: Sonos dropped support for the ",(0,o.jsx)(n.code,{children:"Connect:Amp"})," device (the one with a line in for the phonograph) more or less while I was unwrapping it, and immediately commenced a nagging campaign to get us to upgrade to a shiny and incompatible v2 of their smartphone app. ",(0,o.jsx)(n.a,{href:"#user-content-fnref-1","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{id:"user-content-fn-4",children:["\n",(0,o.jsxs)(n.p,{children:['"Macro pads" are small mechanical keyboards with just a handful of keys, each of which is then programmed to send some useful, but hard to type, keyboard shortcut ',(0,o.jsx)(n.a,{href:"#user-content-fnref-4","data-footnote-backref":"","aria-label":"Back to reference 2",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{id:"user-content-fn-2",children:["\n",(0,o.jsxs)(n.p,{children:["Presumably with audio streamed over UDP and ordinary http requests for commands and events ",(0,o.jsx)(n.a,{href:"#user-content-fnref-2","data-footnote-backref":"","aria-label":"Back to reference 3",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{id:"user-content-fn-3",children:["\n",(0,o.jsxs)(n.p,{children:["specifically, a ",(0,o.jsx)(n.a,{href:"https://www.raspberrypi.com/products/raspberry-pi-zero-w/",children:"Raspberry Pi Zero W"})," v1.1 ",(0,o.jsx)(n.a,{href:"#user-content-fnref-3","data-footnote-backref":"","aria-label":"Back to reference 4",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n"]}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(x,{...e})}):x(e)}}}]);