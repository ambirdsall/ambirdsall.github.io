"use strict";(self.webpackChunkambirdsall_com=self.webpackChunkambirdsall_com||[]).push([[67],{8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>i});var o=t(6540);const r={},a=o.createContext(r);function s(e){const n=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(a.Provider,{value:n},e.children)}},8866:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>l,default:()=>u,frontMatter:()=>d,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"noisebot/index","title":"I, Noisebot","description":"Or: How I made playing records through my home Sonos set up nice with some DIY dedicated hardware. You can find the project code on my github.","source":"@site/projects/noisebot/index.mdx","sourceDirName":"noisebot","slug":"/noisebot/","permalink":"/projects/noisebot/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"projectSidebar","previous":{"title":"Projects of mine","permalink":"/projects/"},"next":{"title":"Setting Up The Mini Keyboard","permalink":"/projects/noisebot/mini-keyboard"}}');var r=t(4848),a=t(8453),s=t(2331);const i=t.p+"assets/images/mini-keeb-1df4f174d208680a47718782f84b2c60.avif",d={},l="I, Noisebot",h={},c=[{value:"The Problem",id:"the-problem",level:2},{value:"A Better Way",id:"a-better-way",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",section:"section",sup:"sup",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"i-noisebot",children:"I, Noisebot"})}),"\n",(0,r.jsxs)(n.p,{children:["Or: How I made playing records through my home Sonos set up nice with some DIY dedicated hardware. You can find the project code ",(0,r.jsx)(n.a,{href:"https://github.com/ambirdsall/noisebot",children:"on my github"}),"."]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"This write-up was started a few months after finishing the project, and so there is a chance I have misremembered some detail, some side learning, some bit of context. Do leave a comment if you catch a mistake!"})}),"\n",(0,r.jsx)(n.h2,{id:"the-problem",children:"The Problem"}),"\n",(0,r.jsxs)(n.p,{children:["I bought a couple of Sonos speakers some years back. It has been great for streaming digital audio, but some of the shine wore off when I added my phonograph to the system",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-1",id:"user-content-fnref-1","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})}),". I was using a setup something like this:"]}),"\n",(0,r.jsx)(n.mermaid,{value:'graph TB\n    A["Bedroom<br>\ud83d\udd0a"]\n    B["Kitchen<br>\ud83d\udd0a"]\n    C["Living Room<br>\ud83d\udd0a"]\n    D["TV Room<br>\ud83d\udd0a"]\n    \n    %% Vertical alignment for analog components\n    subgraph AnalogSource[" "]\n        direction TB\n        Phono["Record Player<br>\ud83c\udfb5 "]\n        E["Line In<br>\ud83c\udfb5\ud83d\udd17\ud83d\udd08"]\n        Phono --\x3e E\n    end\n\n    class A,B,C,D speakerNode;\n\n    %% Dotted grey bidirectional connections\n    B <-.-> C\n    B <-.-> D\n    E <-.-> B\n    E <-.-> C\n    E <-.-> D\n    A <-.-> B\n    A <-.-> C\n    A <-.-> D\n    E <-.-> A\n\n    classDef speakerNode fill:#d1e8ff,stroke:#1e90ff,stroke-width:2px,color:#000;\n    linkStyle default stroke:#999,stroke-dasharray: 4 4;\n    linkStyle 0 stroke:#333,stroke-width:2px,stroke-dasharray: 0;'}),"\n",(0,r.jsx)(n.p,{children:"I didn't have speakers wired to the Line In box, which meant actually playing a record required the following steps:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"take out my smartphone and open the sonos app"}),"\n",(0,r.jsx)(n.li,{children:'go to the "rooms" tab'}),"\n",(0,r.jsx)(n.li,{children:'select the "Line In" device'}),"\n",(0,r.jsx)(n.li,{children:'hit the "Group" button and connect another speaker\u2014"Living Room", say'}),"\n",(0,r.jsx)(n.li,{children:'go to the "browse" tab'}),"\n",(0,r.jsx)(n.li,{children:'select the "Line in" input (provided by the Line In "room", i.e. device)'}),"\n",(0,r.jsx)(n.li,{children:"put the record on the phonograph"}),"\n",(0,r.jsx)(n.li,{children:"start the phonograph spinning"}),"\n",(0,r.jsx)(n.li,{children:"put the needle down"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Changing the volume was another whole round of taps:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"take out phone, open sonos app"}),"\n",(0,r.jsx)(n.li,{children:'back to the "rooms" tab'}),"\n",(0,r.jsx)(n.li,{children:"select the line in group"}),"\n",(0,r.jsx)(n.li,{children:"pull up selected group's playback controls to get volume"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["It was all perfectly ",(0,r.jsx)(n.em,{children:"doable"}),"\u2014and credit where due, the volume slider interface is very nice when you get there\u2014but tapping through all those screens added friction, made it feel like a chore, and we didn't listen to records at all for a long time. There had to be a better way."]}),"\n",(0,r.jsx)(n.h2,{id:"a-better-way",children:"A Better Way"}),"\n",(0,r.jsx)(n.p,{children:"Here's the process I wanted:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"put the record on the phonograph"}),"\n",(0,r.jsx)(n.li,{children:"start the phonograph spinning"}),"\n",(0,r.jsx)(n.li,{children:"press some easy to reach button next to the phonograph that does all the work to connect speaker(s) and route audio"}),"\n",(0,r.jsx)(n.li,{children:"put the needle down"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"And for changing the volume:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"twiddle a volume knob"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The breakthrough was finding a library to control the speakers. I knew Sonos speakers coordinate over wifi with network calls",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-2",id:"user-content-fnref-2","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})}),", so if I had a programatic way to send those calls and buttons to trigger them, I could automate away all the bother with telephones."]}),"\n",(0,r.jsxs)(n.p,{children:["The open-source libraries I found for interacting with sonos were all on npm; I've written a lot of javascript in my career, so a node script was old hat. I did some quick experiments and went with the first package that worked, which you can find as ",(0,r.jsx)(n.code,{children:"sonos"})," on npm and ",(0,r.jsx)(n.code,{children:"node-sonos"})," ",(0,r.jsx)(n.a,{href:"https://github.com/bencevans/node-sonos",children:"on github"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["For hardware, I had an unused raspberry pi zero",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-3",id:"user-content-fnref-3","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"3"})})," around: that gave me a computer which was tiny enough to stash in a small device, while still having a wifi antenna to communicate with the speakers and enough CPU to run a node script in an ordinary linux terminal. As a programmer, I do enough typing to have researched keyboard enthusiast spaces online; I had seen quite a few examples of macro pads",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-4",id:"user-content-fnref-4","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"4"})})," equipped with just a handful of keys and a rotary knob, just the UI I wanted. The programming model is straightforward, too: connect a keyboard to a terminal running a node script, and the script just has to listen on ",(0,r.jsx)(n.code,{children:"stdin"})," to trigger arbitrary functions for each of its keys. My plan was coming together nicely, with a high-level setup like this:"]}),"\n",(0,r.jsx)(n.mermaid,{value:'graph TD\n    subgraph "Hey let\'s hear a record"\n        Keyboard["Macro Pad<br>(\u2328 + \ud83c\udf9b)"]\n        Pi["Raspberry Pi Zero W<br>\ud83e\udd16 running a <code>node-sonos</code>-based node.js script"]\n        Keyboard --\x3e Pi\n    end\n\n    subgraph "Sonos System"\n        Speakers["Living Room et al<br>\ud83d\udd0a\ud83d\udd0a\ud83d\udd0a"]\n        ConnectAmp["Line In<br>\ud83c\udfb5\ud83d\udd17\ud83d\udd08"]\n        Phono["Record Player<br>\ud83c\udfb5 "]\n\n        Phono --\x3e ConnectAmp\n        Speakers <-.-> ConnectAmp\n    end\n\n    Pi -.-> Speakers\n    Pi -.-> ConnectAmp\n\n    %% Style only the dotted arrows (links 5 and 6)\n    linkStyle 2 stroke:#888,stroke-dasharray: 5;\n    linkStyle 3 stroke:#888,stroke-dasharray: 5;\n    linkStyle 4 stroke:#888,stroke-dasharray: 5;'}),"\n",(0,r.jsxs)(n.p,{children:["This looked close to ideal, and the only thing I didn't already own was a little macro pad; so I went ahead and ordered ",(0,r.jsx)(n.a,{href:"https://www.aliexpress.us/item/3256807827316893.html",children:"the cheapest one I could find on aliexpress"}),":"]}),"\n",(0,r.jsx)("div",{style:{margin:"auto",width:"20em"},children:(0,r.jsx)(s.A,{img:i})}),"\n",(0,r.jsx)(n.p,{children:"To realize my plan I had to solve three problems, which could be treated as independent, non-blocking tasks until it was time to bring everything together:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"write a headless but interactive sonos TUI in node.js: I could write and run the code on a normal laptop if the Raspberry Pi weren't ready, using the laptop keyboard to trigger actions if the mini one weren't ready"}),"\n",(0,r.jsxs)(n.li,{children:["set up a raspberry pi zero to run the above script, using ",(0,r.jsx)(n.code,{children:"ssh"})," to test the software if the mini keyboard weren't ready"]}),"\n",(0,r.jsx)(n.li,{children:"find out what codes my mini keyboard sends for each key and the knob, remapping them as needed; this has no dependency on the Raspberry Pi"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Each problem has a dedicated page with a more detailed explanation. Let's dig in!"}),"\n","\n",(0,r.jsxs)(n.section,{"data-footnotes":!0,className:"footnotes",children:[(0,r.jsx)(n.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{id:"user-content-fn-1",children:["\n",(0,r.jsxs)(n.p,{children:["Part of this was just collateral damage from a classically graceless corporate upgrade: Sonos dropped support for the ",(0,r.jsx)(n.code,{children:"Connect:Amp"})," device (the one with a line in for the phonograph) more or less while I was unwrapping it, and immediately commenced a nagging campaign to get us to upgrade to a shiny and incompatible v2 of their smartphone app. ",(0,r.jsx)(n.a,{href:"#user-content-fnref-1","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{id:"user-content-fn-2",children:["\n",(0,r.jsxs)(n.p,{children:["Presumably with audio streamed over UDP and ordinary http requests for commands and events ",(0,r.jsx)(n.a,{href:"#user-content-fnref-2","data-footnote-backref":"","aria-label":"Back to reference 2",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{id:"user-content-fn-3",children:["\n",(0,r.jsxs)(n.p,{children:["specifically, a ",(0,r.jsx)(n.a,{href:"https://www.raspberrypi.com/products/raspberry-pi-zero-w/",children:"Raspberry Pi Zero W"})," v1.1 ",(0,r.jsx)(n.a,{href:"#user-content-fnref-3","data-footnote-backref":"","aria-label":"Back to reference 3",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{id:"user-content-fn-4",children:["\n",(0,r.jsxs)(n.p,{children:['"Macro pads" are small mechanical keyboards with just a handful of keys, each of which is then programmed to send some useful, but hard to type, keyboard shortcut ',(0,r.jsx)(n.a,{href:"#user-content-fnref-4","data-footnote-backref":"","aria-label":"Back to reference 4",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}}}]);