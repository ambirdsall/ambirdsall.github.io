"use strict";(self.webpackChunkambirdsall_com=self.webpackChunkambirdsall_com||[]).push([[3320],{1553:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>d});var s=t(9398),o=t(4848),i=t(8453);const a={slug:"berkely-db-design-lessons",title:"Berkely DB Design Lessons",topic:"quotes",date:new Date("2016-08-31T00:00:00.000Z"),tags:["quotes","design","architecture"]},r=void 0,l={authorsImageUrls:[]},d=[{value:"Design Lesson 1",id:"design-lesson-1",level:2},{value:"Design Lesson 2",id:"design-lesson-2",level:2},{value:"Design Lesson 3",id:"design-lesson-3",level:2},{value:"Design Lesson 4",id:"design-lesson-4",level:2},{value:"Design Lesson 5",id:"design-lesson-5",level:2},{value:"Design Lesson 6",id:"design-lesson-6",level:2},{value:"Design Lesson 7",id:"design-lesson-7",level:2},{value:"Design Lesson 8",id:"design-lesson-8",level:2},{value:"Design Lesson 9",id:"design-lesson-9",level:2},{value:"Design Lesson 10",id:"design-lesson-10",level:2},{value:"Design Lesson 11",id:"design-lesson-11",level:2},{value:"Design Lesson 12",id:"design-lesson-12",level:2},{value:"Design Lesson 13",id:"design-lesson-13",level:2},{value:"Design Lesson 14",id:"design-lesson-14",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",h2:"h2",hr:"hr",p:"p",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["Notes taken while reading the ",(0,o.jsx)(n.a,{href:"http://www.aosabook.org/en/bdb.html",children:"Berkeley DB"})," section\nof ",(0,o.jsx)(n.a,{href:"http://www.aosabook.org/en/index.html",children:"The Architecture of Open-Source Applications"}),",\nwhich breaks up its discussion of the application's specific architecture with general\nlessons and aphorisms. Read the whole thing, it's great."]}),"\n","\n",(0,o.jsxs)(n.p,{children:["There's a grimness to these that I find utterly charming: ",(0,o.jsx)(n.a,{href:"#design-lesson-3",children:"lesson\n3"}),' warns "[s]oftware architecture degrades in direct\nproportion to the number of changes made to the software: bug fixes corrode the\nlayering and new features stress design." It\'s an approach that treats software\ndesign in general and object orientation in specific (OO as in "code that goes\n\'not my job, you figure it out\'", not as in "code that is organized with\nclasses") not like a matter of artistic composition so much as intellectual\nsanitation. It\'s a dirty world out there: wash your ass.']}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-1",children:"Design Lesson 1"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"It is vital for any complex software package's testing and maintenance that the\nsoftware be designed and built as a cooperating set of modules with\nwell-defined API boundaries. The boundaries can (and should!) shift as needs\ndictate, but they always need to be there. The existence of those boundaries\nprevents the software from becoming an unmaintainable pile of spaghetti. Butler\nLampson once said that all problems in computer science can be solved by\nanother level of indirection. More to the point, when asked what it meant for\nsomething to be object-oriented, Lampson said it meant being able to have\nmultiple implementations behind an API. The Berkeley DB design and\nimplementation embody this approach of permitting multiple implementations\nbehind a common interface, providing an object-oriented look and feel, even\nthough the library is written in C."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-2",children:"Design Lesson 2"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"A software design is simply one of several ways to force yourself to think\nthrough the entire problem before attempting to solve it. Skilled programmers\nuse different techniques to this end: some write a first version and throw it\naway, some write extensive manual pages or design documents, others fill out a\ncode template where every requirement is identified and assigned to a specific\nfunction or comment. For example, in Berkeley DB, we created a complete set of\nUnix-style manual pages for the access methods and underlying components before\nwriting any code. Regardless of the technique used, it's difficult to think\nclearly about program architecture after code debugging begins, not to mention\nthat large architectural changes often waste previous debugging effort.\nSoftware architecture requires a different mind set from debugging code, and\nthe architecture you have when you begin debugging is usually the architecture\nyou'll deliver in that release."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-3",children:"Design Lesson 3"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Software architecture does not age gracefully. Software architecture degrades\nin direct proportion to the number of changes made to the software: bug fixes\ncorrode the layering and new features stress design. Deciding when the software\narchitecture has degraded sufficiently that you should re-design or re-write a\nmodule is a hard decision. On one hand, as the architecture degrades,\nmaintenance and development become more difficult and at the end of that path\nis a legacy piece of software maintainable only by having an army of\nbrute-force testers for every release, because nobody understands how the\nsoftware works inside. On the other hand, users will bitterly complain over the\ninstability and incompatibilities that result from fundamental changes. As a\nsoftware architect, your only guarantee is that someone will be angry with you\nno matter which path you choose."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-4",children:"Design Lesson 4"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:'It doesn\'t matter how you name your variables, methods, functions, or what\ncomments or code style you use; that is, there are a large number of formats\nand styles that are "good enough." What does matter, and matters very much, is\nthat naming and style be consistent. Skilled programmers derive a tremendous\namount of information from code format and object naming. You should view\nnaming and style inconsistencies as some programmers investing time and effort\nto lie to the other programmers, and vice versa. Failing to follow house coding\nconventions is a firing offense.'}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-5",children:"Design Lesson 5"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Software architects must choose their upgrade battles carefully: users will\naccept minor changes to upgrade to new releases (if you guarantee compile-time\nerrors, that is, obvious failures until the upgrade is complete; upgrade\nchanges should never fail in subtle ways). But to make truly fundamental\nchanges, you must admit it's a new code base and requires a port of your user\nbase. Obviously, new code bases and application ports are not cheap in time or\nresources, but neither is angering your user base by telling them a huge\noverhaul is really a minor upgrade."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-6",children:"Design Lesson 6"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"In library design, respect for the namespace is vital. Programmers who use your\nlibrary should not need to memorize dozens of reserved names for functions,\nconstants, structures, and global variables to avoid naming collisions between\nan application and the library."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-7",children:"Design Lesson 7"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Before we wrote a shared-memory linked-list package, Berkeley DB engineers\nhand-coded a variety of different data structures in shared memory, and these\nimplementations were fragile and difficult to debug. The shared-memory list\npackage, modeled after the BSD list package (queue.h), replaced all of those\nefforts. Once it was debugged, we never had to debug another shared memory\nlinked-list problem. This illustrates three important design principles: First,\nif you have functionality that appears more than once, write the shared\nfunctions and use them, because the mere existence of two copies of any\nspecific functionality in your code guarantees that one of them is incorrectly\nimplemented. Second, when you develop a set of general purpose routines, write\na test suite for the set of routines, so you can debug them in isolation.\nThird, the harder code is to write, the more important for it to be separately\nwritten and maintained; it's almost impossible to keep surrounding code from\ninfecting and corroding a piece of code."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-8",children:"Design Lesson 8"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Write-ahead logging is another example of providing encapsulation and layering,\neven when the functionality is never going to be useful to another piece of\nsoftware: after all, how many programs care about LSNs in the cache?\nRegardless, the discipline is useful and makes the software easier to maintain,\ntest, debug and extend."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-9",children:"Design Lesson 9"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Berkeley DB's choice to use page-level locking was made for good reasons, but\nwe've found that choice to be problematic at times. Page-level locking limits\nthe concurrency of the application as one thread of control modifying a record\non a database page will prevent other threads of control from modifying other\nrecords on the same page, while record-level locks permit such concurrency as\nlong as the two threads of control are not modifying the same record.\nPage-level locking enhances stability as it limits the number of recovery paths\nthat are possible (a page is always in one of a couple of states during\nrecovery, as opposed to the infinite number of possible states a page might be\nin if multiple records are being added and deleted to a page). As Berkeley DB\nwas intended for use as an embedded system where no database administrator\nwould be available to fix things should there be corruption, we chose stability\nover increased concurrency."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-10",children:"Design Lesson 10"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Berkeley DB's general-purpose design was well rewarded when we added concurrent\ndata store functionality. Initially Berkeley DB provided only two modes of\noperation: either you ran without any write concurrency or with full\ntransaction support. Transaction support carries a certain degree of complexity\nfor the developer and we found some applications wanted improved concurrency\nwithout the overhead of full transactional support. To provide this feature, we\nadded support for API-level locking that allows concurrency, while guaranteeing\nno deadlocks. This required a new and different lock mode to work in the\npresence of cursors. Rather than adding special purpose code to the lock\nmanager, we were able to create an alternate lock matrix that supported only\nthe lock modes necessary for the API-level locking. Thus, simply by configuring\nthe lock manager differently, we were able provide the locking support we\nneeded. (Sadly, it was not as easy to change the access methods; there are\nstill significant parts of the access method code to handle this special mode\nof concurrent access.)"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-11",children:"Design Lesson 11"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"When you find an architectural problem you don't want to fix \"right now\" and\nthat you're inclined to just let go, remember that being nibbled to death by\nducks will kill you just as surely as being trampled by elephants. Don't be too\nhesitant to change entire frameworks to improve software structure, and when\nyou make the changes, don't make a partial change with the idea that you'll\nclean up later\u2014do it all and then move forward. As has been often repeated, \"If\nyou don't have the time to do it right now, you won't find the time to do it\nlater.\" And while you're changing the framework, write the test structure as\nwell."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-12",children:"Design Lesson 12"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Mpool and Log use internal handle methods to facilitate write-ahead logging,\nand in some cases, the method declaration is longer than the code it runs,\nsince the code is often comparing two integral values and nothing more. Why\nbother with such insignificant methods, just to maintain consistent layering?\nBecause if your code is not so object-oriented as to make your teeth hurt, it\nis not object-oriented enough. Every piece of code should do a small number of\nthings and there should be a high-level design encouraging programmers to build\nfunctionality out of smaller chunks of functionality, and so on. If there's\nanything we have learned about software development in the past few decades, it\nis that our ability to build and maintain significant pieces of software is\nfragile. Building and maintaining significant pieces of software is difficult\nand error-prone, and as the software architect, you must do everything that you\ncan, as early as you can, as often as you can, to maximize the information\nconveyed in the structure of your software."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-13",children:"Design Lesson 13"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"There is rarely such thing as an unimportant bug. Sure, there's a typo now and\nthen, but usually a bug implies somebody didn't fully understand what they were\ndoing and implemented the wrong thing. When you fix a bug, don't look for the\nsymptom: look for the underlying cause, the misunderstanding, if you will,\nbecause that leads to a better understanding of the program's architecture as\nwell as revealing fundamental underlying flaws in the design itself."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"design-lesson-14",children:"Design Lesson 14"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Database recovery is a complex topic, difficult to write and harder to debug\nbecause recovery simply shouldn't happen all that often. In his Turing Award\nLecture, Edsger Dijkstra argued that programming was inherently difficult and\nthe beginning of wisdom is to admit we are unequal to the task. Our goal as\narchitects and programmers is to use the tools at our disposal: design, problem\ndecomposition, review, testing, naming and style conventions, and other good\nhabits, to constrain programming problems to problems we can solve."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var s=t(6540);const o={},i=s.createContext(o);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:n},e.children)}},9398:e=>{e.exports=JSON.parse('{"permalink":"/blog/berkely-db-design-lessons","source":"@site/blog/berkeley_db.mdx","title":"Berkely DB Design Lessons","description":"Notes taken while reading the Berkeley DB section","date":"2016-08-31T00:00:00.000Z","tags":[{"inline":false,"label":"Quotes","permalink":"/blog/tags/quotes","description":"Quotes tag description"},{"inline":false,"label":"Design","permalink":"/blog/tags/design","description":"Design tag description"},{"inline":false,"label":"Architecture","permalink":"/blog/tags/architecture","description":"Architecture tag description"}],"readingTime":9.84,"hasTruncateMarker":true,"authors":[],"frontMatter":{"slug":"berkely-db-design-lessons","title":"Berkely DB Design Lessons","topic":"quotes","date":"2016-08-31T00:00:00.000Z","tags":["quotes","design","architecture"]},"unlisted":false,"lastUpdatedAt":1745535817000,"prevItem":{"title":"Locks Are Some Shit","permalink":"/blog/locks-are-some-shit"}}')}}]);